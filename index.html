<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, signInAnonymously, signInWithCustomToken, 
        onAuthStateChanged, setPersistence, browserSessionPersistence 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, addDoc, onSnapshot, collection, query, 
        serverTimestamp, setLogLevel 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Global Instances and Variables ---
    let app, db, auth;
    let userId = 'loading-user';
    let servicesData = [];
    let currentCategory = 'All Services';

    // --- Firebase Config ---
    const YOUR_FIREBASE_CONFIG_JSON = `{
        "apiKey": "", 
        "authDomain": "fijilocallink.firebaseapp.com",
        "projectId": "fijilocallink",
        "storageBucket": "fijilocallink.appspot.com",
        "messagingSenderId": "246057187129",
        "appId": "1:246057187129:web:0ce25c1aa059b360badaee8"
    }`;

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'fijilocallink';
    let firebaseConfig;

    try {
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            console.log("✅ Using environment-provided Firebase config.");
        } else {
            firebaseConfig = JSON.parse(YOUR_FIREBASE_CONFIG_JSON);
            console.log("⚠️ Using hardcoded Firebase config (may need manual key input).");
        }
    } catch (e) {
        console.error("❌ Failed to parse Firebase config:", e);
        renderStatus("Configuration Error", "Cannot read Firebase keys.", true);
        throw new Error("Configuration Parse Failure");
    }

    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    setLogLevel('debug');

    // --- UI Utilities ---
    function updateStepStatus(stepId, status = 'current') {
        const step = document.getElementById(stepId);
        if (!step) return;
        const icon = step.querySelector('.loading-icon');
        step.classList.remove('current', 'success', 'text-red-600');
        icon.classList.remove('bg-primary-blue', 'bg-gray-300', 'bg-red-500', 'animate-pulse');

        if (status === 'current') {
            step.classList.add('current');
            icon.classList.add('bg-primary-blue', 'animate-pulse');
        } else if (status === 'success') {
            step.classList.add('success');
            icon.classList.add('bg-green-500');
            icon.classList.remove('animate-pulse');
        } else if (status === 'fail') {
            step.classList.add('text-red-600');
            icon.classList.add('bg-red-500');
        }
    }

    function showModal(title, message, isError = false) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-body').textContent = message;
        const titleEl = document.getElementById('modal-title');
        if (isError) {
            titleEl.classList.add('text-red-600');
        } else {
            titleEl.classList.remove('text-red-600');
        }
        document.getElementById('modal-container').classList.remove('hidden');
    }

    window.closeModal = function() {
        document.getElementById('modal-container').classList.add('hidden');
    }

    function renderStatus(title, message, isError = false) {
        const statusDiv = document.getElementById('status-message');
        const appContent = document.getElementById('app-content');
        statusDiv.innerHTML = `
            <div class="p-4">
                <p class="text-xl font-bold ${isError ? 'text-red-600' : 'text-gray-600'}">${title}</p>
                <p class="mt-2 text-center text-gray-700">${message}</p>
            </div>
        `;
        if (isError) {
            statusDiv.classList.add('bg-red-100', 'border-red-500', 'border');
        } else {
            statusDiv.classList.remove('bg-red-100', 'border-red-500', 'border');
            statusDiv.classList.add('bg-white');
        }
        appContent.classList.add('hidden');
        statusDiv.classList.remove('hidden');
    }

    function renderApp() {
        document.getElementById('status-message').classList.add('hidden');
        document.getElementById('app-content').classList.remove('hidden');
    }

    function getCategoryColor(category) {
        switch (category) {
            case 'Trades': return 'border-yellow-500 bg-yellow-50';
            case 'Food': return 'border-green-500 bg-green-50';
            case 'Health': return 'border-red-500 bg-red-50';
            default: return 'border-gray-500 bg-gray-50';
        }
    }

    function renderServices() {
        const container = document.getElementById('services-list');
        const filtered = currentCategory === 'All Services'
            ? servicesData
            : servicesData.filter(s => s.category === currentCategory);

        if (filtered.length === 0) {
            container.innerHTML = '<p class="text-center text-gray-500 p-8 border border-dashed rounded-lg">No services listed in this category yet.</p>';
            return;
        }

        container.innerHTML = filtered.map(service => `
            <div class="bg-white p-4 rounded-lg shadow-md border-l-4 ${getCategoryColor(service.category)}">
                <h3 class="text-lg font-bold text-gray-800">${service.title || 'Untitled Service'}</h3>
                <p class="text-sm text-gray-600 mt-1 whitespace-pre-wrap">${service.description || 'No description provided.'}</p>
                <div class="flex justify-between items-center mt-3">
                    <span class="text-xs font-semibold px-2 py-1 rounded-full border ${getCategoryColor(service.category)}">${service.category || 'Other'}</span>
                    <span class="text-xs text-gray-500">Posted by: ${service.userId || 'unknown'}</span>
                </div>
            </div>
        `).join('');
    }

    window.handleCategoryChange = function(category, btn) {
        currentCategory = category;
        document.querySelectorAll('.category-button').forEach(b => {
            b.classList.remove('bg-primary-blue', 'text-white');
            b.classList.add('bg-white', 'text-gray-700', 'border');
        });
        btn.classList.add('bg-primary-blue', 'text-white');
        btn.classList.remove('bg-white', 'text-gray-700', 'border');
        renderServices();
    }

    function showAddServiceModal() {
        if (!auth || !userId) {
            showModal("Authentication Required", "Please wait for the app to finish connecting before listing a service.");
            return;
        }

        const modalHtml = `
            <div id="add-service-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-xl w-full max-w-sm shadow-2xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">List a New Service</h3>
                        <button onclick="closeAddServiceModal()" class="text-gray-400 hover:text-gray-600 text-2xl font-light">&times;</button>
                    </div>
                    <form id="add-service-form">
                        <div class="mb-4">
                            <label for="service-title" class="block text-sm font-medium text-gray-700 mb-1">Service Title</label>
                            <input type="text" id="service-title" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue">
                        </div>
                        <div class="mb-4">
                            <label for="service-description" class="block text-sm font-medium text-gray-700 mb-1">Description & Contact</label>
                            <textarea id="service-description" rows="4" required class="w-full p-3 border border-gray-300 rounded-lg resize-none focus:ring-primary-blue focus:border-primary-blue"></textarea>
                        </div>
                        <div class="mb-6">
                            <label for="service-category" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                            <select id="service-category" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue">
                                <option value="Trades">Trades</option>
                                <option value="Food">Food</option>
                                <option value="Health">Health</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <button type="submit" id="submit-service-btn" class="w-full py-3 bg-primary-blue text-white font-semibold rounded-lg shadow-md hover:bg-blue-800 transition duration-150">
                            Submit Service Listing
                        </button>
                    </form>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        document.getElementById('add-service-form').addEventListener('submit', submitServiceListing);
    }

    window.closeAddServiceModal = function() {
        document.getElementById('add-service-modal')?.remove();
    }

    async function submitServiceListing(e) {
        e.preventDefault();
        const btn = document.getElementById('submit-service-btn');
        btn.disabled = true;
        btn.textContent = 'Saving...';

        const title = document.getElementById('service-title').value.trim();
        const description = document.getElementById('service-description').value.trim();
        const category = document.getElementById('service-category').value;

        try {
            const servicesCollection = collection(db, 'artifacts', appId, 'public/data/services');
            await addDoc(servicesCollection, {
                title,
                description,
                category,
                userId,
                timestamp: serverTimestamp()
            });
            closeAddServiceModal();
            showModal("Success!", "Your service has been listed and is now visible to others.");
        } catch (error) {
            console.error("Error adding document:", error);
            showModal("Submission Failed", `Failed to list service: ${error.message}`, true);
        } finally {
            btn.disabled = false;
            btn.textContent = 'Submit Service Listing';
        }
    }

    // --- Firebase Initialization ---
    async function initializeFirebase() {
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            updateStepStatus('step-1', 'success');
            updateStepStatus('step-2', 'current');

            await setPersistence(auth, browserSessionPersistence);
            let initialCheckDone = false;

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                    updateStepStatus('step-2', 'success');
                    updateStepStatus('step-3', 'current');

                    try {
                        const servicesCollection = collection(db, 'artifacts', appId, 'public/data/services');
                        const q = query(servicesCollection);
                        onSnapshot(q, (snapshot) => {
                            servicesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            renderServices();
                            renderApp()
    
