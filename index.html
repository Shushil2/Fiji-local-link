<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiji Local Link</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font family -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .tab-button { transition: all 0.2s; }
        .tab-button.active {
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .scroll-hidden::-webkit-scrollbar { display: none; }
        .scroll-hidden { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center">

    <div id="app" class="w-full max-w-md bg-white shadow-2xl min-h-screen flex flex-col">

        <!-- Header -->
        <header id="header" class="bg-blue-600 text-white p-4 rounded-b-xl shadow-lg z-10">
            <h1 class="text-xl font-bold text-center">Fiji Local Link</h1>
            <p class="text-sm text-center">Connecting essential services in Fiji.</p>
            <p id="user-id-display" class="text-xs opacity-80 text-center font-mono">
                (User ID: Loading...)
            </p>
        </header>

        <!-- Category Tabs -->
        <div id="category-tabs" class="flex-shrink-0 flex justify-center space-x-2 p-3 bg-white shadow-md z-10 sticky top-0 scroll-hidden overflow-x-auto">
            <!-- Tabs will be dynamically added here -->
        </div>

        <!-- Content Area -->
        <main id="content-area" class="flex-grow p-4 space-y-4 pt-6">
            <!-- Services and Status will appear here -->
            <div id="status-card" class="bg-white p-6 rounded-xl shadow-md flex flex-col items-center justify-center min-h-[150px]">
                <div id="status-spinner" class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mb-3"></div>
                <p id="status-message" class="text-gray-600 text-center">Initializing App...</p>
            </div>
        </main>

        <!-- Floating Action Button (FAB) -->
        <button id="fab" class="fixed bottom-6 right-6 bg-blue-600 text-white p-4 rounded-full shadow-lg hover:bg-blue-700 transition duration-150 z-20">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
        </button>

        <!-- Modal for Adding New Service -->
        <div id="modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-30">
            <div id="add-service-modal" class="bg-white w-full max-w-sm rounded-xl shadow-2xl p-6 transform transition-all scale-95 opacity-0">
                <h2 class="text-xl font-bold mb-4 text-gray-800">List a New Service</h2>
                <input type="text" id="service-name" placeholder="Service Name (e.g., 4R Electrics)" class="w-full p-3 mb-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <textarea id="service-content" placeholder="Description and Contact (e.g., Electrical contractors, Ba Fiji, Contact mobile 999 9999)" rows="3" class="w-full p-3 mb-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                <select id="service-category" class="w-full p-3 mb-5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <!-- Options populated by JS -->
                </select>
                <div class="flex justify-end space-x-3">
                    <button id="cancel-service-btn" class="px-4 py-2 text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">Cancel</button>
                    <button id="list-service-btn" class="px-4 py-2 text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition duration-150">List Service</button>
                </div>
            </div>
        </div>

        <!-- Alert Modal for Errors/Messages -->
        <div id="alert-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-40">
            <div id="alert-modal" class="bg-white w-full max-w-xs rounded-xl shadow-2xl p-6 transform transition-all scale-95 opacity-0">
                <h2 id="alert-title" class="text-xl font-bold mb-3 text-red-600">Error</h2>
                <p id="alert-message" class="text-gray-700 mb-5">An error occurred.</p>
                <div class="flex justify-end">
                    <button id="alert-ok-btn" class="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 transition duration-150">Understood</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, setLogLevel, doc, onSnapshot, collection, query, where, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- GLOBAL STATE & CONFIGURATION ---
        let app;
        let db;
        let auth;
        let unsubscribeServiceListener = null;

        // Global state must be initialized clearly
        let currentUser = null; 
        let isAuthReady = false;
        let servicesData = {};
        let activeCategory = 'All Services';
        const CATEGORIES = ['All Services', 'Trades', 'Food', 'Health', 'Other'];
        
        // Canvas Global Variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firestore Collection Path
        const PUBLIC_COLLECTION_PATH = `/artifacts/${appId}/public/data/services`;

        // --- UTILITY FUNCTIONS ---

        /**
         * Custom alert/modal function. Replaces native alert() and confirm().
         * @param {string} title - The title of the alert.
         * @param {string} message - The main message.
         * @param {string} [type='error'] - 'error' or 'info'.
         */
        function showAlert(title, message, type = 'error') {
            const backdrop = document.getElementById('alert-backdrop');
            const modal = document.getElementById('alert-modal');
            const titleEl = document.getElementById('alert-title');
            const messageEl = document.getElementById('alert-message');
            const okBtn = document.getElementById('alert-ok-btn');

            titleEl.textContent = title;
            messageEl.textContent = message;

            // Set colors based on type
            if (type === 'error') {
                titleEl.className = 'text-xl font-bold mb-3 text-red-600';
                okBtn.className = 'px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 transition duration-150';
            } else { // 'info'
                titleEl.className = 'text-xl font-bold mb-3 text-blue-600';
                okBtn.className = 'px-4 py-2 text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition duration-150';
            }

            okBtn.onclick = () => {
                backdrop.classList.add('hidden');
                backdrop.classList.remove('flex');
                modal.classList.remove('scale-100', 'opacity-100');
                modal.classList.add('scale-95', 'opacity-0');
            };

            backdrop.classList.remove('hidden');
            backdrop.classList.add('flex');
            // Animate in
            setTimeout(() => {
                modal.classList.remove('scale-95', 'opacity-0');
                modal.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        /**
         * Updates the status message in the main content area.
         * @param {string} message - The message to display.
         * @param {boolean} isLoading - Whether to show the spinner.
         */
        function renderStatus(message, isLoading = false) {
            const statusCard = document.getElementById('status-card');
            const statusMessage = document.getElementById('status-message');
            const statusSpinner = document.getElementById('status-spinner');
            const contentArea = document.getElementById('content-area');

            // Clear previous service cards
            const serviceCards = contentArea.querySelectorAll('.service-card');
            serviceCards.forEach(card => card.remove());

            statusMessage.textContent = message;
            statusSpinner.style.display = isLoading ? 'block' : 'none';
            statusCard.style.display = 'flex';
        }

        /**
         * Converts a Firestore document snapshot into a simplified object.
         */
        function docToService(doc) {
            const data = doc.data();
            return {
                id: doc.id,
                name: data.name,
                content: data.content,
                category: data.category || 'Other',
                timestamp: data.timestamp ? data.timestamp.toDate() : new Date(),
                userId: data.userId || 'unknown',
            };
        }

        /**
         * Renders a single service card.
         * @param {object} service - The service data object.
         */
        function renderServiceCard(service) {
            const timeAgo = (new Date() - service.timestamp) / (1000 * 60); // minutes ago
            const timeDisplay = timeAgo < 60 ? `${Math.round(timeAgo)}m ago` : service.timestamp.toLocaleDateString();

            const card = document.createElement('div');
            card.className = 'service-card bg-white p-4 rounded-xl shadow-lg border-l-4 border-blue-500';
            card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-lg font-bold text-gray-800">${service.name}</h3>
                    <span class="text-xs text-gray-500">${timeDisplay}</span>
                </div>
                <p class="text-gray-600 mb-3 whitespace-pre-wrap">${service.content}</p>
                <div class="flex justify-between items-center text-xs">
                    <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full font-medium">${service.category}</span>
                    <span class="text-gray-400 font-mono">Posted: ${service.userId.substring(0, 8)}...</span>
                </div>
            `;
            return card;
        }

        /**
         * Toggles the visibility of the Add Service Modal.
         * @param {boolean} show - True to show, false to hide.
         */
        function toggleModal(show) {
            const backdrop = document.getElementById('modal-backdrop');
            const modal = document.getElementById('add-service-modal');
            if (show) {
                backdrop.classList.remove('hidden');
                backdrop.classList.add('flex');
                setTimeout(() => {
                    modal.classList.remove('scale-95', 'opacity-0');
                    modal.classList.add('scale-100', 'opacity-100');
                }, 10);
            } else {
                modal.classList.remove('scale-100', 'opacity-100');
                modal.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    backdrop.classList.remove('flex');
                    backdrop.classList.add('hidden');
                    // Clear fields
                    document.getElementById('service-name').value = '';
                    document.getElementById('service-content').value = '';
                }, 300);
            }
        }

        // --- FIREBASE INITIALIZATION & AUTHENTICATION ---

        async function initFireBaseApp() {
            setLogLevel('debug'); // Enable detailed logging

            if (!firebaseConfig) {
                renderStatus("CRITICAL CONFIGURATION ERROR: Firebase configuration is missing. This usually happens when the app is run outside a secure environment like Canvas.", false);
                showAlert("Critical Configuration Error", "Startup failed: Firebase configuration keys are missing or invalid. The app cannot connect to the database.", 'error');
                return;
            }

            try {
                // 1. Initialize App and Services
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Set Auth Persistence (important for real-world usage)
                await setPersistence(auth, browserSessionPersistence);

                // 2. Handle Authentication
                renderStatus("Connecting to Database...", true);
                
                // Use a promise to handle custom token sign-in or fallback
                await new Promise(async (resolve, reject) => {
                    // Timeout Guard (in case custom token hangs)
                    let authAttempted = false;
                    const timeoutId = setTimeout(() => {
                        if (!authAttempted) {
                            console.warn("[AUTH] Authentication timeout. Falling back to anonymous sign-in if needed.");
                            // If a user is already signed in (e.g., from a previous session), onAuthStateChanged will handle it.
                            // If not, we rely on the logic below.
                        }
                        resolve(); // Resolve anyway to continue
                    }, 8000); // 8 second timeout

                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                            console.log("[AUTH] Signed in with Custom Token successfully.");
                        } else {
                            // If custom token is not defined (e.g. running in a simple dev environment or fallback after failure)
                            await signInAnonymously(auth);
                            console.log("[AUTH] Signed in anonymously successfully (No custom token provided).");
                        }
                        authAttempted = true;
                        clearTimeout(timeoutId);
                        resolve();

                    } catch (error) {
                        clearTimeout(timeoutId);
                        authAttempted = true;
                        console.error("[AUTH] Authentication Error:", error.code, error.message);
                        // If custom token fails, try to sign in anonymously as a fallback
                        try {
                            if (!auth.currentUser) {
                                await signInAnonymously(auth);
                                console.log("[AUTH] Custom token failed, signed in anonymously as fallback.");
                            }
                            resolve();
                        } catch (anonError) {
                            console.error("[AUTH] Anonymous Sign-In Fallback failed:", anonError.code, anonError.message);
                            // Set a specific error state for the user
                            const userIdElement = document.getElementById('user-id-display');
                            if (userIdElement) {
                                userIdElement.textContent = '(User ID: AUTH_FAIL)';
                            }
                            showAlert("Authentication Failure", "The application could not establish a connection to the Firebase database. Please check your network and configuration.", 'error');
                            reject(anonError);
                        }
                    }
                });

                // 3. Setup Auth State Listener (CRITICAL for updating currentUserId)
                onAuthStateChanged(auth, (user) => {
                    isAuthReady = true;
                    const userIdElement = document.getElementById('user-id-display');

                    if (user) {
                        // FIX: Ensure the currentUserId is set to the full UID
                        currentUser = user.uid;
                        
                        // FIX: Display the full UID as required
                        const userIdDisplay = `(User ID: ${currentUser})`;
                        console.log(`[AUTH READY] User signed in. UID: ${currentUser}`);
                        
                        if (userIdElement) {
                            userIdElement.textContent = userIdDisplay;
                        }

                        // Load data now that we have a user
                        loadActiveCategory();
                        
                    } else {
                        // This block runs if sign-in fails or user signs out
                        currentUser = 'Guest User';
                        const userIdDisplay = `(User ID: ${currentUser})`;
                        console.warn(`[AUTH READY] No authenticated user. Current state: ${currentUser}`);

                        if (userIdElement) {
                            userIdElement.textContent = userIdDisplay;
                        }
                        
                        // Still load data, assuming public access is allowed by rules
                        loadActiveCategory();
                    }
                });


            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                renderStatus("CRITICAL ERROR: Firebase services could not be initialized.", false);
                const errorMessage = error.message.includes('api-key-not-valid') ? 
                    "Startup failed: Firebase API Key is not valid. The app cannot connect to the database." : 
                    "An unexpected error occurred during startup. Please check the console for details.";
                showAlert("Critical Initialization Error", errorMessage, 'error');
                
                // Final attempt to update user ID display to show failure
                const userIdElement = document.getElementById('user-id-display');
                if (userIdElement) {
                    userIdElement.textContent = '(User ID: INIT_FAIL)';
                }
            }
        }


        // --- FIREBASE DATA OPERATIONS ---

        /**
         * Starts the real-time listener for the currently active category.
         */
        function loadActiveCategory() {
            if (!db || !isAuthReady) {
                renderStatus("Waiting for connection...", true);
                return;
            }

            // Stop previous listener if it exists
            if (unsubscribeServiceListener) {
                unsubscribeServiceListener();
                unsubscribeServiceListener = null;
            }

            renderStatus(`Loading ${activeCategory === 'All Services' ? 'all' : activeCategory} services...`, true);

            try {
                const servicesRef = collection(db, PUBLIC_COLLECTION_PATH);
                let q;

                if (activeCategory === 'All Services') {
                    // Query for all services
                    q = query(servicesRef);
                } else {
                    // Query for services in the specific category
                    q = query(servicesRef, where('category', '==', activeCategory));
             
