<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiji Local Link</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        /* Custom scrollbar for better mobile feel */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="min-h-screen">

    <!-- Header / Top Bar -->
    <header class="bg-blue-600 shadow-lg sticky top-0 z-10">
        <div class="max-w-xl mx-auto p-4 text-white text-center rounded-b-xl">
            <h1 class="text-2xl font-bold">Fiji Local Link</h1>
            <p class="text-sm opacity-90">Connecting essential services in Fiji.</p>
            <p id="user-id-display" class="text-xs mt-1 bg-blue-700/50 p-1 rounded-full inline-block px-3">User ID: Loading...</p>
        </div>
    </header>

    <main class="max-w-xl mx-auto p-4">

        <!-- Category Tabs -->
        <div id="category-tabs" class="flex overflow-x-auto whitespace-nowrap space-x-2 pb-2 mb-4">
            <!-- Tabs will be rendered here -->
        </div>

        <!-- Content Area -->
        <div id="content-area" class="bg-white p-4 rounded-xl shadow-md min-h-96 flex flex-col items-center justify-center">
            <!-- Initial state: Loading -->
            <div id="loading-spinner" class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent mx-auto"></div>
                <p class="mt-4 text-gray-600">Connecting to Database...</p>
            </div>

            <!-- Error Message Box (Hidden by default) -->
            <div id="error-message-box" class="hidden text-center p-6 m-4 bg-red-50 border-2 border-red-300 rounded-xl shadow-lg w-full max-w-sm">
                <h3 class="text-xl font-bold text-red-600 mb-2">Database Connection Error</h3>
                <p class="text-gray-700 text-sm mb-4" id="error-details">
                    Could not load services from the database. Please check the console for details and ensure you have read/write permissions.
                </p>
                <button onclick="window.location.reload();" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-md">
                    Reload App
                </button>
            </div>

            <!-- No Services Found Message (Hidden by default) -->
            <div id="no-services-message" class="hidden text-center p-6">
                <img src="https://placehold.co/100x100/FEE300/000?text=ðŸ“‹" onerror="this.src='https://placehold.co/100x100/F0F4FF/2563EB?text=No+Data'" class="mx-auto mb-4 w-20 h-20"/>
                <h3 class="text-xl font-bold text-gray-700 mb-2">No services found in this category.</h3>
                <p class="text-gray-500">Be the first to list a service!</p>
            </div>

            <!-- Services List Container -->
            <div id="services-list-container" class="w-full">
                <!-- Services cards will be rendered here -->
            </div>
        </div>
    </main>

    <!-- Floating Action Button for Adding New Service -->
    <button id="add-service-btn" class="fixed bottom-6 right-6 z-20 bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-full shadow-2xl transition duration-300 transform active:scale-95 text-3xl">
        +
    </button>

    <!-- Modal for Listing a New Service (Hidden by default) -->
    <div id="add-service-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-30 flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm transform transition-all">
            <h2 class="text-xl font-bold text-gray-800 mb-4">List a New Service</h2>
            <input type="text" id="service-name-input" placeholder="Service Name (e.g., 4R Electrics)" class="w-full p-3 mb-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
            <textarea id="service-details-input" placeholder="Details (e.g., Electrical contractors, Ba Fiji, Contact mobile 999 9999)" rows="3" class="w-full p-3 mb-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required></textarea>
            <select id="service-category-select" class="w-full p-3 mb-6 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                <!-- Options populated by JS -->
            </select>
            <div class="flex justify-end space-x-3">
                <button id="cancel-service-btn" class="text-gray-600 hover:text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-200">Cancel</button>
                <button id="list-service-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-md">List Service</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Import necessary Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            query, 
            onSnapshot, 
            addDoc,
            serverTimestamp,
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set log level for debugging
        setLogLevel('Debug');

        // --- GLOBAL & FIREBASE CONFIGURATION ---
        
        let app, db, auth;
        let currentUserId = 'Loading...';
        let isAuthReady = false;
        
        // --- FALLBACK CONFIGURATION FOR EXTERNAL DEPLOYMENT (GITHUB PAGES) ---
        // If you deploy this to GitHub Pages, the Canvas variables will be undefined.
        // You MUST replace the placeholder values below with your actual, public 
        // Firebase config to allow connection outside the secure Canvas environment.
        const NON_CANVAS_FIREBASE_CONFIG = {
            // !!! REPLACE 'YOUR_API_KEY_HERE' WITH YOUR ACTUAL KEY FOR EXTERNAL DEPLOYMENT !!!
            apiKey: "YOUR_API_KEY_HERE", 
            authDomain: "your-project-id.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project-id.appspot.com",
            messagingSenderId: "1234567890",
            appId: "1:234567890:web:abcdef"
        };
        // ------------------------------------------------------------------------

        // Retrieve global variables provided by the Canvas environment (Secure)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig = null;
        let initialAuthToken = null;

        if (typeof __firebase_config !== 'undefined') {
            // Running in Canvas: Use secure, injected config
            try {
                firebaseConfig = JSON.parse(__firebase_config);
                initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            } catch (e) {
                console.error("Error parsing __firebase_config:", e);
                // Fallback to error state if parsing fails
            }
        } else {
            // Running outside Canvas (e.g., GitHub Pages): Use hardcoded public fallback
            console.warn("Canvas environment variables not found. Using NON_CANVAS_FIREBASE_CONFIG.");
            if (NON_CANVAS_FIREBASE_CONFIG.apiKey === "YOUR_API_KEY_HERE") {
                console.error("CRITICAL WARNING: NON_CANVAS_FIREBASE_CONFIG uses placeholders. Update them for GitHub Pages deployment.");
            }
            firebaseConfig = NON_CANVAS_FIREBASE_CONFIG;
        }

        // Collection path for public data
        const PUBLIC_COLLECTION_PATH = `/artifacts/${appId}/public/data/services`;

        // Service Categories
        const CATEGORIES = ['All Services', 'Trades', 'Food', 'Health', 'Other'];
        let activeCategory = CATEGORIES[0];

        // --- DOM ELEMENTS ---
        const userIdDisplay = document.getElementById('user-id-display');
        const categoryTabsContainer = document.getElementById('category-tabs');
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorMessageBox = document.getElementById('error-message-box');
        const errorDetails = document.getElementById('error-details');
        const noServicesMessage = document.getElementById('no-services-message');
        const servicesListContainer = document.getElementById('services-list-container');
        const addServiceBtn = document.getElementById('add-service-btn');
        const addServiceModal = document.getElementById('add-service-modal');
        const cancelServiceBtn = document.getElementById('cancel-service-btn');
        const listServiceBtn = document.getElementById('list-service-btn');
        const serviceNameInput = document.getElementById('service-name-input');
        const serviceDetailsInput = document.getElementById('service-details-input');
        const serviceCategorySelect = document.getElementById('service-category-select');

        // --- UTILITY FUNCTIONS ---

        /** Shows a specific section and hides others. */
        function renderState(state, message = '') {
            loadingSpinner.classList.add('hidden');
            errorMessageBox.classList.add('hidden');
            noServicesMessage.classList.add('hidden');
            servicesListContainer.classList.add('hidden');
            addServiceBtn.classList.remove('hidden'); // Show the FAB by default

            switch (state) {
                case 'LOADING':
                    loadingSpinner.classList.remove('hidden');
                    break;
                case 'ERROR':
                    errorMessageBox.classList.remove('hidden');
                    errorDetails.textContent = message || 'An unknown error occurred. Check the console for more information.';
                    addServiceBtn.classList.add('hidden'); // Hide FAB on critical error
                    break;
                case 'NO_DATA':
                    noServicesMessage.classList.remove('hidden');
                    break;
                case 'HAS_DATA':
                    servicesListContainer.classList.remove('hidden');
                    break;
            }
        }

        /** Renders the list of services as cards. */
        function renderServices(services) {
            servicesListContainer.innerHTML = ''; // Clear previous services
            
            if (!services || services.length === 0) {
                renderState('NO_DATA');
                return;
            }

            // Sort services by date/timestamp (newest first)
            services.sort((a, b) => {
                const dateA = a.postedDate?.toDate()?.getTime() || 0;
                const dateB = b.postedDate?.toDate()?.getTime() || 0;
                return dateB - dateA;
            });

            services.forEach(service => {
                const date = service.postedDate ? new Date(service.postedDate.toDate()).toLocaleDateString() : 'N/A';
                
                const serviceCard = `
                    <div class="service-card bg-gray-50 p-4 mb-3 rounded-xl shadow hover:shadow-lg transition duration-200 border-l-4 border-blue-500">
                        <div class="flex justify-between items-start">
                            <div class="flex-1 min-w-0 pr-2">
                                <h3 class="text-xl font-bold text-gray-800 mb-1">${service.title}</h3>
                                <p class="text-sm text-gray-600 whitespace-pre-line">${service.details}</p>
                            </div>
                            <div class="text-right flex-shrink-0">
                                <span class="text-xs font-semibold text-white bg-blue-500 py-1 px-2 rounded-full shadow-md">${service.category}</span>
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-2">Posted: ${date} | User: ${service.userId.substring(0, 8)}...</p>
                    </div>
                `;
                servicesListContainer.innerHTML += serviceCard;
            });

            renderState('HAS_DATA');
        }

        // --- FIREBASE INITIALIZATION & AUTHENTICATION ---

        /** Initializes Firebase App and handles authentication. */
        async function initFirebaseApp() {
            renderState('LOADING');

            if (!firebaseConfig || (firebaseConfig.apiKey === "YOUR_API_KEY_HERE" && typeof __firebase_config === 'undefined')) {
                // Critical configuration check for external deployment placeholders
                console.error("CRITICAL_FIREBASE_ERROR: Firebase configuration is missing or using placeholder keys externally.");
                renderState('ERROR', 'Critical Startup Error: Firebase configuration is missing or invalid. Check console for details.');
                return;
            }

            try {
                // 1. Initialize App and Services
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (error) {
                console.error("FIREBASE_INITIALIZATION_ERROR:", error);
                renderState('ERROR', `Startup failed: Firebase initialization error. Details: ${error.message}`);
                return;
            }

            // 2. Setup Auth State Listener
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    isAuthReady = true;
                    
                    userIdDisplay.textContent = `User ID: ${currentUserId.substring(0, 10)}...`;
                    console.log(`Firebase user signed in. UID: ${currentUserId}`);
                    
                    listenForServices();
                    renderCategoryTabs(); 

                } else {
                    // 3. Handle Authentication (Attempt sign-in)
                    try {
                        if (initialAuthToken) {
                            // Canvas: Sign in with custom token
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            // External/Fallback: Sign in anonymously
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        currentUserId = 'AUTH_ERROR';
                        userIdDisplay.textContent = 'User ID: INIT_ERROR';
                        isAuthReady = true; 
                        console.error("FIREBASE_AUTHENTICATION_ERROR:", error);
                        renderState('ERROR', `Authentication failed. Details: ${error.message}`);
                    }
                }
            });
        }

        // --- DATA INTERACTION (FIRESTORE) ---
        
        /** Listens for real-time updates to the services collection based on the active category. */
        function listenForServices() {
            if (!isAuthReady || !db) return;

            const servicesCollectionRef = collection(db, PUBLIC_COLLECTION_PATH);
            let servicesQuery = query(servicesCollectionRef);

            // Add category filtering if not 'All Services'
            if (activeCategory !== CATEGORIES[0]) {
                servicesQuery = query(servicesCollectionRef, where('category', '==', activeCategory));
            }
            
            renderState('LOADING', `Loading ${activeCategory} services...`);


            // Setup real-time listener (onSnapshot)
            const unsubscribe = onSnapshot(servicesQuery, (snapshot) => {
                try {
                    const services = [];
                    snapshot.forEach((doc) => {
                        services.push({ id: doc.id, ...doc.data() });
                    });
                    
                    renderServices(services);
                } catch (error) {
                    console.error("FIRESTORE_DATA_ERROR: Could not load data.", error);
                    renderState('ERROR', 'Data Error: Could not load services. Check the console.');
                }
            }, (error) => {
                // This callback handles errors during the snapshot subscription itself
                console.error("FIRESTORE_SNAPSHOT_ERROR:", error);
                renderState('ERROR', 'Database Connection Error: Snapshot listener failed. Check network or permissions.');
            });

            // Note: The unsubscribe function is returned but not explicitly used here. 
            // In a single-page app, this leak is acceptable.
            return unsubscribe;
        }

        /** Adds a new service document to Firestore. */
        async function addNewService(title, details, category) {
            if (!isAuthReady || !db || !auth.currentUser) {
                return { success: false, message: "Authentication required to list a service." };
            }

            const serviceData = {
                title: title.trim(),
                details: details.trim(),
                category: category,
                userId: auth.currentUser.uid, 
                postedDate: serverTimestamp() 
            };

            try {
                await addDoc(collection(db, PUBLIC_COLLECTION_PATH), serviceData);
                return { success: true };
            } catch (error) {
                console.error("ERROR ADDING DOCUMENT:", error);
                return { success: false, message: `Failed to add service: ${error.message}` };
            }
        }

        // --- UI RENDERING & EVENT HANDLERS ---
        
        /** Renders the category tabs and attaches click handlers. */
        function renderCategoryTabs() {
            categoryTabsContainer.innerHTML = ''; 
            serviceCategorySelect.innerHTML = ''; 

            CATEGORIES.forEach((category, index) => {
                // Populate the selection dropdown for the modal (excluding "All Services")
                if (category !== CATEGORIES[0]) {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    serviceCategorySelect.appendChild(option);
                }

                // Create the tab button
                const isActive = category === activeCategory;
                const button = document.createElement('button');
                button.textContent = category;
                button.className = `py-2 px-4 rounded-full font-semibold transition duration-200 shadow-sm flex-shrink-0 ${
                    isActive 
                        ? 'bg-blue-600 text-white' 
                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                }`;
                
                button.addEventListener('click', () => {
                    if (activeCategory !== category) {
                        activeCategory = category;
                        renderCategoryTabs(); 
                        listenForServices(); 
                    }
                });

                categoryTabsContainer.appendChild(button);
            });
        }
    
