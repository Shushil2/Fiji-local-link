<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiji Local Link</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f4f7fa; }
        .tab-button { transition: all 0.2s; }
    </style>
</head>
<body class="p-0 sm:p-4 min-h-screen">

    <div id="app-container" class="max-w-xl mx-auto bg-white rounded-lg shadow-xl min-h-screen sm:min-h-[85vh] flex flex-col">

        <!-- Header -->
        <header class="bg-blue-600 text-white p-4 rounded-t-lg shadow-md">
            <h1 class="text-2xl font-bold text-center">Fiji Local Link</h1>
            <p class="text-sm text-center opacity-80">Connecting essential services in Fiji.</p>
            <p id="user-id-display" class="text-xs text-center mt-1 font-mono bg-blue-700/50 p-1 rounded-full w-fit mx-auto transition-colors duration-300">User ID: Loading...</p>
        </header>

        <!-- Category Tabs -->
        <div id="category-tabs" class="flex p-3 space-x-2 overflow-x-auto bg-gray-50 border-b border-gray-200 sticky top-0 z-10">
            <!-- Tab buttons will be rendered here -->
        </div>

        <!-- Main Content Area -->
        <main class="p-4 flex-grow overflow-y-auto">
            <div id="service-list-container">
                <!-- Services or initial messages will be rendered here -->
            </div>
        </main>

        <!-- Floating Action Button (FAB) -->
        <button id="add-service-fab" class="fixed right-4 bottom-4 w-14 h-14 bg-blue-600 text-white rounded-full shadow-lg hover:bg-blue-700 focus:outline-none transition-transform duration-300 transform hover:scale-105 z-20">
            <svg class="w-8 h-8 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
        </button>

        <!-- Modal Placeholder -->
        <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-30">
            <!-- Modal content will be inserted here -->
        </div>

        <!-- Error/Message Modal Placeholder -->
        <div id="message-modal-container" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-40">
            <!-- Message/Error content will be inserted here -->
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserSessionPersistence, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, where, doc, addDoc, serverTimestamp, setDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Enable debug logging for troubleshooting Firebase
        setLogLevel('Debug');

        // --- HARDCODED FIREBASE CONFIGURATION (FOR GITHUB PAGES/PUBLIC USE) ---
        // This configuration is based on the data you previously provided.
        // It must be defined directly here because Canvas global variables are not available.
        const LIVE_FIREBASE_CONFIG = {
            apiKey: "AIzaSyCDKDZeYK3UT3Cuynda7HDzV9RQY-vDxh8",
            authDomain: "fijilocallink.firebaseapp.com",
            projectId: "fijilocallink",
            storageBucket: "fijilocallink.appspot.com",
            messagingSenderId: "246057187129",
            appId: "1:246057187129:web:0ce25c1aa059b360badae8"
        };
        // ---------------------------------------------------------------------


        // ---------------------------------------------------------------------
        // GLOBAL STATE & VARIABLES
        // ---------------------------------------------------------------------
        let app;
        let db;
        let auth;
        let currentUserId = 'Loading...';
        let currentAppId = 'fijilocallink-app'; // Default/Live App ID
        let currentCategory = 'All Services';
        let categories = ['All Services', 'Trades', 'Food', 'Health', 'Other'];
        let servicesCache = []; // Cache for all services fetched from Firestore
        let isAuthReady = false;

        // Public collection path construction: /artifacts/{appId}/public/data/services
        const getCollectionPath = () => {
            return `artifacts/${currentAppId}/public/data/services`;
        };

        const userIdDisplay = document.getElementById('user-id-display');
        const serviceListContainer = document.getElementById('service-list-container');
        const fab = document.getElementById('add-service-fab');
        const modalContainer = document.getElementById('modal-container');
        const messageModalContainer = document.getElementById('message-modal-container');


        // ---------------------------------------------------------------------
        // UI RENDERING FUNCTIONS
        // ---------------------------------------------------------------------

        /**
         * Renders a generic message/error modal.
         * @param {string} title - The title of the message (e.g., "Error", "Success").
         * @param {string} message - The body message.
         * @param {string} type - "error" or "info".
         */
        function renderMessageModal(title, message, type = 'info', actionCallback = null) {
            const isError = type === 'error';
            const colorClass = isError ? 'bg-red-500 hover:bg-red-600' : 'bg-blue-500 hover:bg-blue-600';
            const buttonText = isError ? 'Understood' : 'OK';

            messageModalContainer.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm transform transition-all duration-300">
                    <div class="flex items-center space-x-3 mb-4">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center ${isError ? 'bg-red-100' : 'bg-blue-100'}">
                            <svg class="w-6 h-6 ${isError ? 'text-red-600' : 'text-blue-600'}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${isError ? 'M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' : 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z'}"></path></svg>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800">${title}</h3>
                    </div>
                    <p class="text-gray-600 mb-6">${message}</p>
                    <button id="modal-close-btn" class="w-full py-3 rounded-xl text-white font-semibold ${colorClass} transition duration-150">
                        ${buttonText}
                    </button>
                    ${isError ? `<button id="modal-reload-btn" class="w-full mt-2 py-3 rounded-xl text-red-600 border border-red-600 bg-white hover:bg-red-50 transition duration-150 font-semibold">Reload App</button>` : ''}
                </div>
            `;
            messageModalContainer.classList.remove('hidden');
            messageModalContainer.classList.add('flex');

            const closeBtn = document.getElementById('modal-close-btn');
            closeBtn.onclick = () => {
                messageModalContainer.classList.add('hidden');
                messageModalContainer.classList.remove('flex');
                if (actionCallback) actionCallback();
            };

            if (isError) {
                document.getElementById('modal-reload-btn').onclick = () => window.location.reload();
            }
        }

        /**
         * Renders the loading state in the main content area.
         * @param {string} message - The message to display (e.g., "Connecting to Database...").
         * @param {boolean} showSpinner - Whether to show the spinner.
         */
        function renderLoadingState(message, showSpinner = true) {
            serviceListContainer.innerHTML = `
                <div class="flex flex-col items-center justify-center p-12 bg-gray-50 rounded-xl shadow-inner mt-4">
                    ${showSpinner ? '<div class="animate-spin rounded-full h-10 w-10 border-4 border-blue-500 border-t-transparent mb-4"></div>' : ''}
                    <p class="text-lg font-medium text-gray-700">${message}</p>
                </div>
            `;
        }

        /**
         * Renders the current list of services based on the selected category.
         */
        function renderServices() {
            const filteredServices = servicesCache.filter(service =>
                currentCategory === 'All Services' || service.category === currentCategory
            );

            if (filteredServices.length === 0) {
                const categoryText = currentCategory === 'All Services' ? 'any' : `in this category: ${currentCategory}`;
                serviceListContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center p-12 bg-white rounded-xl text-center shadow">
                        <svg class="w-16 h-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 002 2h2a2 2 0 002-2"></path></svg>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">No services found ${categoryText}.</h3>
                        <p class="text-gray-500">Be the first to list a service!</p>
                    </div>
                `;
                return;
            }

            serviceListContainer.innerHTML = filteredServices.map(service => `
                <div class="bg-white p-4 rounded-xl shadow-md mb-4 border-l-4 border-blue-500 transition-shadow hover:shadow-lg">
                    <h2 class="text-lg font-bold text-gray-800">${service.title}</h2>
                    <p class="text-gray-600 mt-1">${service.content}</p>
                    <div class="flex justify-between items-center mt-3 text-sm text-gray-500">
                        <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">${service.category}</span>
                        <span class="text-xs">Posted: ${service.timestamp ? new Date(service.timestamp.toDate()).toLocaleDateString() : 'N/A'}</span>
                    </div>
                </div>
            `).join('');
        }

        /**
         * Renders the category selection tabs.
         */
        function renderCategoryTabs() {
            const tabsContainer = document.getElementById('category-tabs');
            tabsContainer.innerHTML = categories.map(cat => `
                <button
                    data-category="${cat}"
                    class="tab-button px-4 py-2 text-sm font-semibold rounded-full whitespace-nowrap ${currentCategory === cat ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}"
                >
                    ${cat}
                </button>
            `).join('');

            tabsContainer.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    currentCategory = e.target.dataset.category;
                    renderCategoryTabs();
                    renderServices();
                });
            });
        }

        /**
         * Renders the "List a New Service" form modal.
         */
        function renderAddServiceModal() {
            modalContainer.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm transform transition-all duration-300">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">List a New Service</h2>
                    <form id="add-service-form">
                        <div class="mb-4">
                            <label for="service-title" class="block text-sm font-medium text-gray-700 mb-1">Service Title (e.g., 4R Electrics)</label>
                            <input type="text" id="service-title" name="title" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="mb-4">
                            <label for="service-content" class="block text-sm font-medium text-gray-700 mb-1">Description & Contact Info</label>
                            <textarea id="service-content" name="content" required rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 resize-none"></textarea>
                        </div>
                        <div class="mb-6">
                            <label for="service-category" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                            <select id="service-category" name="category" required class="w-full p-3 border border-gray-300 bg-white rounded-lg focus:ring-blue-500 focus:border-blue-500 appearance-none">
                                ${categories.filter(c => c !== 'All Services').map(c => `<option value="${c}">${c}</option>`).join('')}
                            </select>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" id="cancel-add-service" class="px-4 py-2 text-gray-600 bg-gray-200 rounded-lg font-semibold hover:bg-gray-300 transition duration-150">Cancel</button>
                            <button type="submit" id="list-service-btn" class="px-4 py-2 text-white bg-blue-600 rounded-lg font-semibold hover:bg-blue-700 transition duration-150">List Service</button>
                        </div>
                    </form>
                </div>
            `;
            modalContainer.classList.remove('hidden');
            modalContainer.classList.add('flex');

            document.getElementById('cancel-add-service').onclick = () => {
                modalContainer.classList.add('hidden');
                modalContainer.classList.remove('flex');
            };

            document.getElementById('add-service-form').onsubmit = handleAddService;
        }


        // ---------------------------------------------------------------------
        // FIREBASE INITIALIZATION & AUTHENTICATION
        // ---------------------------------------------------------------------

        // Check if we are running in the Canvas environment (optional environment variables present)
        const isCanvasEnvironment = typeof __firebase_config !== 'undefined';

        // Set up configuration based on environment
        let firebaseConfig = LIVE_FIREBASE_CONFIG;
        if (isCanvasEnvironment) {
             try {
                // If Canvas globals are present, use them for secure setup
                firebaseConfig = JSON.parse(__firebase_config);
                currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            } catch (e) {
                console.error("Failed to parse Canvas config:", e);
                // Fallback to hardcoded config if parsing fails
            }
        }
        
        // Retrieve custom token only if running in Canvas
        const initialAuthToken = isCanvasEnvironment && typeof __initial_auth_token !== 'undefined'
            ? __initial_auth_token : null;

        /**
         * Initializes Firebase and starts authentication process.
         */
        async function initFirebaseApp() {
            renderLoadingState('Connecting to Database...');
            
            try {
                // 1. Initialize App and Services
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Set persistence for real-world usage
                await setPersistence(auth, browserSessionPersistence);

                // 2. Handle Authentication
                // Use a promise/timeout guard for authentication completion
                await new Promise((resolve, reject) => {
                    let authAttempted = false;
                    
                    const timeoutId = setTimeout(() => {
                        if (!authAttempted) {
                            reject(new Error("Authentication timeout. Check network or rules."));
                        }
                    }, 5000); // 5 second timeout

                    onAuthStateChanged(auth, async (user) => {
                        clearTimeout(timeoutId);
                        authAttempted = true;

                        if (user) {
                            // Already signed in (e.g., from session persistence)
                            currentUserId = user.uid;
                            resolve();
                        } else {
                            try {
                                if (initialAuthToken) {
                                    // Sign in with custom token (Canvas environment)
                                    await signInWithCustomToken(auth, initialAuthToken);
                                } else {
                                    // Sign in anonymously (live/public environment)
                                    const userCredential = await signInAnonymously(auth);
                                    currentUserId = userCredential.user.uid;
                                }
                                resolve();
                            } catch (error) {
                                // If custom token fails (e.g., expired), fall back to anonymous sign-in in Canvas.
                                // In live environment, anonymous sign-in failure is a fatal error.
                                console.error("Authentication Error:", error);
                                if (error.code === 'auth/custom-token-mismatch' && isCanvasEnvironment) {
                                    console.warn("Custom token failed, falling back to anonymous sign-in.");
                                    const userCredential = await signInAnonymously(auth);
                                    currentUserId = userCredential.user.uid;
                                    resolve();
                                } else {
                                    reject(new Error(`Authentication failed: ${error.message}. Please check security rules.`));
                                }
                            }
                        }
                    });
                });

                // Authentication successful
                isAuthReady = true;
                console.log(`Firebase initialized. User ID: ${currentUserId}. App ID: ${currentAppId}`);
                
                // Update UI and start fetching data
                userIdDisplay.textContent = `User ID: ${currentUserId.substring(0, 15)}...`;
                renderCategoryTabs();
                startListeningForServices();


            } catch (error) {
                // Critical Initialization Error (either config missing or auth failed)
                console.error("Startup failed:", error);
                userIdDisplay.textContent = 'User ID: INIT_ERROR';
                renderMessageModal('Critical Connection Error', `Startup failed: ${error.
