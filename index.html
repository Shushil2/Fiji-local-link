<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiji Local Link</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#0A4AF1',
                        'secondary-green': '#4C7F59',
                        'fiji-gold': '#FFD700',
                        'fiji-blue': '#102A4A',
                        'fiji-coral': '#F27B4A',
                    },
                },
            },
        }
    </script>
    <style>
        /* Import Inter font from Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }

        /* Utility classes for active tab and modal backdrop */
        .tab-active {
            border-bottom: 3px solid var(--primary-blue);
            font-weight: 600;
            color: var(--primary-blue);
            transition: all 0.2s ease-in-out;
        }

        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }

        /* Custom scrollbar for better aesthetics */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(16, 42, 74, 0.4); /* fiji-blue semi-transparent */
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .like-btn:active {
            transform: scale(0.95);
            transition: transform 0.1s;
        }

        /* Set primary-blue as a CSS variable for easier use in border/shadow */
        :root {
            --primary-blue: #0A4AF1;
        }
    </style>
</head>
<body class="min-h-screen">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, deleteDoc, Timestamp, limit, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Global Variables (must be used for environment setup) ---
        let app;
        let db;
        let auth;
        let currentUserId = 'Loading...';
        let isAuthReady = false;
        
        // --- YOUR CORRECT FIREBASE CONFIGURATION (Based on your project ID) ---
        // This configuration uses the unique IDs we extracted from your screenshots.
        const firebaseConfig = {
          // This API Key is redacted for security, but MUST be your correct key
          apiKey: "AIzaSyC0KD2eYK3UT3Cuynda7HD...", 
          authDomain: "fijilocallink.firebaseapp.com",
          projectId: "fijilocallink",
          storageBucket: "fijilocallink.appspot.com",
          messagingSenderId: "246057187129",
          appId: "1:246057187129:web:0ce25c1aa..." 
        };
        
        // We get the appId directly from the config.
        const appId = firebaseConfig.appId;

        // Service categories for filtering
        const categories = ['All Services', 'Trades', 'Food', 'Health', 'Other'];
        let currentCategory = 'All Services';

        // Custom Modal UI Class (Replaces alert/confirm)
        class CustomModal {
            constructor(modalId) {
                this.modal = document.getElementById(modalId);
                this.titleElement = this.modal.querySelector('#modal-title');
                this.bodyElement = this.modal.querySelector('#modal-body');
                this.buttonContainer = this.modal.querySelector('#modal-buttons');
                
                // Bind close method for reuse
                this.closeModal = this.closeModal.bind(this);
            }

            showModal(title, message, type = 'alert', actions = []) {
                this.titleElement.textContent = title;
                this.bodyElement.innerHTML = message;
                this.buttonContainer.innerHTML = ''; // Clear previous buttons
                
                // Common close button
                const closeButton = document.createElement('button');
                closeButton.textContent = 'Understood';
                closeButton.onclick = this.closeModal;
                closeButton.className = 'w-full py-3 px-4 rounded-xl font-bold transition duration-150';

                if (type === 'alert' || type === 'error') {
                    closeButton.className += (type === 'error' ? ' bg-fiji-coral hover:bg-red-600 text-white' : ' bg-primary-blue hover:bg-blue-600 text-white');
                    this.buttonContainer.appendChild(closeButton);
                } else if (type === 'confirm' && actions.length === 2) {
                    // Custom confirmation buttons (e.g., Cancel and OK)
                    
                    const [cancelAction, confirmAction] = actions;
                    
                    // Cancel Button
                    const cancelButton = document.createElement('button');
                    cancelButton.textContent = cancelAction.label;
                    cancelButton.onclick = () => {
                        cancelAction.callback();
                        this.closeModal();
                    };
                    cancelButton.className = 'flex-1 py-3 px-4 rounded-xl font-bold bg-gray-200 hover:bg-gray-300 transition duration-150';

                    // Confirm Button
                    const confirmButton = document.createElement('button');
                    confirmButton.textContent = confirmAction.label;
                    confirmButton.onclick = () => {
                        confirmAction.callback();
                        this.closeModal();
                    };
                    confirmButton.className = 'flex-1 py-3 px-4 rounded-xl font-bold bg-fiji-coral hover:bg-red-600 text-white ml-3 transition duration-150';

                    this.buttonContainer.classList.add('flex', 'justify-between');
                    this.buttonContainer.appendChild(cancelButton);
                    this.buttonContainer.appendChild(confirmButton);
                }

                this.modal.classList.remove('hidden');
                setTimeout(() => this.modal.querySelector('.modal-content').classList.remove('opacity-0', 'scale-90'), 10);
            }

            closeModal() {
                this.modal.querySelector('.modal-content').classList.add('opacity-0', 'scale-90');
                setTimeout(() => {
                    this.modal.classList.add('hidden');
                    this.buttonContainer.classList.remove('flex', 'justify-between');
                }, 150);
            }
        }
        
        const appModal = new CustomModal('customAlert');

        // --- Firebase Initialization and Auth Logic (CRITICAL for fixing the issue) ---
        function initFirebaseApp() {
            // Set debug log level for better console visibility
            setLogLevel('Debug');
            
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // 1. Start the authentication process
            authenticateUser();

            // 2. Set up the state change listener (This is the single source of truth for user status)
            onAuthStateChanged(auth, async (user) => {
                let newUserId = 'NOT_AUTHENTICATED';
                if (user) {
                    newUserId = user.uid;
                }
                
                currentUserId = newUserId;
                document.getElementById('user-id').textContent = currentUserId;
                
                // If authentication is now ready and the user is signed in (or anonymously signed in)
                if (!isAuthReady && user) {
                    isAuthReady = true;
                    // Only start listening for data AFTER auth is confirmed and ready
                    await listenForServices(); 
                } else if (!user) {
                    // If no user is found after the initial check (which shouldn't happen if Anonymous is enabled)
                    currentUserId = 'NOT_AUTHENTICATED';
                    document.getElementById('user-id').textContent = currentUserId;
                    hideLoader();
                }
            });
        }

        async function authenticateUser() {
            try {
                // Since Anonymous Sign-in is enabled, this should now succeed
                await signInAnonymously(auth);
            } catch (error) {
                // This block catches the "Authentication failed" error
                console.error("Authentication Error:", error);
                showStartupError("Authentication failed. Check your Firebase config or Anonymous sign-in setting.");
            }
        }

        // --- UI State Management ---
        function showLoader(message = "Connecting to Database...") {
            document.getElementById('loading-indicator').classList.remove('hidden');
            document.getElementById('loading-message').textContent = message;
            document.getElementById('content-area').classList.add('hidden');
        }

        function hideLoader() {
            document.getElementById('loading-indicator').classList.add('hidden');
            document.getElementById('content-area').classList.remove('hidden');
        }
        
        function showStartupError(message) {
             hideLoader();
             appModal.showModal('Error', message, 'error');
        }

        // --- Data Listener (Firestore Realtime) ---
        async function listenForServices() {
            if (!db || !isAuthReady) {
                showStartupError("Database not initialized or user not authenticated.");
                return;
            }

            showLoader('Fetching Services...');
            
            // Firestore data path for public, shared data
            const collectionPath = `artifacts/${appId}/public/data/services`;
            
            try {
                // Set up the base query: Sort by creation time (descending) and limit the results
                let servicesRef = collection(db, collectionPath);
                let q = query(servicesRef, orderBy('createdAt', 'desc'), limit(100));

                // Listen for real-time updates
                onSnapshot(q, (snapshot) => {
                    const services = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Cache the services for client-side filtering
                    window.currentServicesCache = services; 
                    renderServices(services);
                    hideLoader();
                }, (error) => {
                    // CRITICAL: Log the error details to the console for debugging
                    console.error("Firestore Real-Time Data Error:", error);
                    let errorMessage = `Could not load services. Check console for details.`;
                    
                    if (error.code === 'permission-denied') {
                        errorMessage += `<br><br>The server reported: <strong>Permission Denied.</strong> This means your Firestore security rules are blocking access.`;
                    }
                    
                    appModal.showModal('Data Error', errorMessage, 'error');
                });

            } catch (e) {
                console.error("Error setting up listener:", e);
                showStartupError("An error occurred during data setup. Check console.");
            }
        }

        // --- Service Rendering and UI Logic ---

        function renderServices(allServices) {
            const listContainer = document.getElementById('service-list');
            listContainer.innerHTML = '';
            
            // Filter services based on the current category
            const filteredServices = currentCategory === 'All Services' 
                ? allServices 
                : allServices.filter(s => s.category === currentCategory);

            if (filteredServices.length === 0) {
                listContainer.innerHTML = `
                    <div class="p-6 bg-white rounded-xl shadow-md text-center">
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">No services found in this category.</h3>
                        <p class="text-gray-500">Be the first to list a service!</p>
                    </div>
                `;
                return;
            }

            filteredServices.forEach(service => {
                const card = document.createElement('div');
                card.className = 'p-5 bg-white rounded-xl shadow-lg border-l-4 border-primary-blue mb-4 transition duration-200 hover:shadow-xl';

                const isOwner = service.ownerId === currentUserId;

                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h2 class="text-xl md:text-2xl font-extrabold text-primary-blue mb-1">${service.name}</h2>
                        <span class="inline-block px-3 py-1 text-xs font-semibold rounded-full ${isOwner ? 'bg-fiji-coral text-white' : 'bg-secondary-green text-white'}">${service.category}</span>
                    </div>
                    
                    <p class="text-gray-600 mb-3">${service.description.substring(0, 100)}${service.description.length > 100 ? '...' : ''}</p>
                    
                    <div class="flex justify-between items-center text-sm text-gray-500">
                        <span>Listed by: ${service.ownerName}</span>
                        <div class="flex items-center space-x-4">
                            ${isOwner ? 
                                `<button onclick="app.confirmDeleteService('${service.id}', '${service.name}')" class="text-fiji-coral hover:text-red-700 font-medium">Delete</button>`
                                : ''}
                            <button class="like-btn text-gray-400 hover:text-red-500 transition duration-150">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                listContainer.appendChild(card);
            });
        }

        function setupCategoryTabs() {
            const tabsContainer = document.getElementById('category-tabs');
            tabsContainer.innerHTML = '';
            categories.forEach(category => {
                const button = document.createElement('button');
                button.textContent = category;
                button.className = `px-4 py-2 text-lg font-medium text-gray-600 border-b-2 border-transparent transition duration-150 hover:text-primary-blue hover:border-primary-blue ${category === currentCategory ? 'tab-active' : ''}`;
                button.onclick = () => {
                    currentCategory = category;
                    const allTabs = tabsContainer.querySelectorAll('button');
                    allTabs.forEach(tab => tab.classList.remove('tab-active'));
                    button.classList.add('tab-active');
                    // Rerender to show filtered results immediately 
                    if (window.currentServicesCache) {
                        renderServices(window.currentServicesCache);
                    }
                };
                tabsContainer.appendChild(button);
            });
        }
        
        // --- Form Submission Logic ---
        async function submitService(event) {
            event.preventDefault();
            
            if (!auth.currentUser || currentUserId === 'NOT_AUTHENTICATED') {
                appModal.showModal("Error", "User is not authenticated. Cannot save service.", 'error');
                return;
            }

            const name = document.getElementById('service-name').value.trim();
            const category = document.getElementById('service-category').value;
            const description = document.getElementById('service-description').value.trim();
            
            // Basic validation
            if (!name || !description || category === 'Select Category') {
                appModal.showModal("Error", "Please fill out all required fields.", 'error');
                return;
            }

            const newService = {
                name: name,
                category: category,
                description: description,
                ownerId: currentUserId,
                ownerName: currentUserId.substring(0, 8) + '...', // Simple user display name
                createdAt: Timestamp.now(),
            };

            const collectionPath = `artifacts/${appId}/public/data/services`;
            
            try {
                // Use addDoc to automatically generate a document ID
                const docRef = await addDoc(collection(db, collectionPath), newService);
                console.log("Document written with ID: ", docRef.id);
                
                appModal.showModal("Success", "Your service has been listed successfully!");
                app.closeModal('serviceModal');
                
                // Clear the form
                document.getElementById('service-name').value = '';
                document.getElementById('service-description').value = '';
                document.getElementById('service-category').value = categories[1]; // Default back to Trades

            } catch (e) {
                console.error("Error adding document: ", e);
                appModal.showModal("Submission Failed", `There was an error saving your service. Please try again. (Details in console)`, 'error');
            }
        }
        
        // --- Delete Service Logic ---
        function confirmDeleteService(serviceId, serviceName) {
            const message = `Are you sure you want to delete the service: <strong>${serviceName}</strong>? This action cannot be undone.`;
            appModal.showModal(
                "Confirm Deletion", 
                message, 
                'confirm', 
                [
                    { label: 'Cancel', callback: () => console.log('Delete cancelled') },
                    { label: 'Delete', callback: () => deleteService(serviceId) }
                ]
            );
        }

        async function deleteService(serviceId) {
            if (!auth.currentUser || currentUserId === 'NOT_AUTHENTICATED') {
                appModal.showModal("Error", "You must be authenticated to delete a service.", 'error');
                return;
            }
            
            const collectionPath = `artifacts/${appId}/public/data/services`;
            const docRef = doc(db, collectionPath, serviceId);
            
            try {
                // The onSnapshot listener will handle UI update in real-time
                await deleteDoc(docRef);
                appModal.showModal("Deleted", "Service successfully removed.", 'alert');
            } catch (e) {
                console.error("Error deleting document: ", e);
                appModal.showModal("Error", `Could not delete the service: ${e.message}`, 'error');
            }
        }


        // --- Exported App Functions for HTML Events ---
        window.app = {
            openModal: (id) => document.getElementById(id).classList.remove('hidden'),
            closeModal: (id) => document.getElementById(id).classList.add('hidden'),
            submitService,
            confirmDeleteService,
        };

        // Initialize the app on window load
        window.onload = function() {
            initFirebaseApp();
            setupCategoryTabs();
        };

    </script>

    <div class="max-w-4xl mx-auto p-4 md:p-6">
        
        <header class="bg-white p-6 rounded-xl shadow-xl text-center mb-6">
            <h1 class="text-4xl font-extrabold text-primary-blue">Fiji Local Link</h1>
            <p class="text-gray-500 text-sm mt-1">Connecting essential services in Fiji. (User ID: <span id="user-id" class="font-mono text-xs font-semibold text-fiji-blue tracking-wider">Loading...</span>)</p>
        </header>

        <div id="loading-indicator" class="text-center p-8 bg-white rounded-xl shadow-md">
            <p id="loading-message" class="text-lg font-semibold text-fiji-blue mb-3">Connecting to Database...</p>
            <div class="flex justify-center items-center">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-primary-blue" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
        </div>

        <div id="content-area" class="hidden">
            <div id="category-tabs" class="flex flex-wrap justify-start items-center space-x-2 md:space-x-6 bg-white rounded-xl shadow-md p-2 md:p-4 mb-6">
                </div>

            <div id="service-list" class="space-y-4 custom-scrollbar max-h-[70vh] overflow-y-auto">
                </div>
        </div>
    </div>

    <button onclick="app.openModal('serviceModal')" class="fixed bottom-6 right-6 p-4 rounded-full bg-primary-blue text-white shadow-lg hover:bg-blue-600 transition duration-150">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
        </svg>
    </button>

    <div id="serviceModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 modal-overlay hidden flex items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl p-6 relative transform transition-all duration-300 scale-100 opacity-100">
            <button onclick="app.closeModal('serviceModal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 class="text-2xl font-bold text-primary-blue mb-6">List Your Essential Service</h2>
            
            <form onsubmit="app.submitService(event)">
                <div class="mb-4">
                    <label for="service-name" class="block text-sm font-medium text-gray-700 mb-1">Service Name/Business Title</label>
                    <input type="text" id="service-name" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-primary-blue focus:border-primary-blue outline-none transition duration-150" placeholder="E.g., Ratu Electrical">
                </div>

                <div class="mb-4">
                    <label for="service-category" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                    <select id="service-category" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-primary-blue focus:border-primary-blue outline-none transition duration-150 appearance-none bg-white">
                        <option value="Trades" selected>Trades (Plumbing, Electrical, Carpentry, etc.)</option>
                        <option value="Food">Food (Takeaway, Restaurant, Catering)</option>
                        <option value="Health">Health (Clinics, Pharmacy, Wellness)</option>
                        <option value="Other">Other (General Services, Retail, etc.)</option>
                    </select>
                </div>

                <div class="mb-6">
                    <label for="service-description" class="block text-sm font-medium text-gray-700 mb-1">Description / Contact Details</label>
                    <textarea id="service-description" required rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-primary-blue focus:border-primary-blue outline-none transition duration-150" placeholder="Describe your service and include a contact number or email."></textarea>
                </div>

                <button type="submit" class="w-full bg-secondary-green text-white font-bold py-3 rounded-xl hover:bg-green-700 transition duration-150 shadow-md">Submit Service</button>
            </form>
        </div>
    </div>

    <div id="customAlert" class="fixed inset-0 bg-gray-900 bg-opacity-75 modal-overlay hidden flex items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="modal-content bg-white rounded-2xl w-full max-w-sm shadow-2xl p-6 relative transform transition-all duration-300 opacity-0 scale-90">
            <h3 id="modal-title" class="text-xl font-bold text-primary-blue mb-4">Alert</h3>
            <p id="modal-body" class="text-gray-600 mb-6"></p>
            <div id="modal-buttons">
                </div>
        </div>
    </div>
    
</body>
</html>
