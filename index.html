<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiji Local Link</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configure Tailwind for custom colors */
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#0A7AF1',
                        'secondary-green': '#1DB9C3',
                        'fiji-gold': '#FFD700',
                        'fiji-blue': '#102A8A',
                        'fiji-coral': '#F2745E',
                    },
                },
            }
        }
    </style>
    <!-- Load Firebase Modules -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Global variables are provided by the Canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = 'loading...'; // Default loading state

        const loader = document.getElementById('loading-indicator');
        const content = document.getElementById('content-area');
        const userIdDisplay = document.getElementById('user-id-display');
        const customAlert = document.getElementById('custom-alert');

        // Utility to show and hide a custom alert modal
        function showAlert(title, message) {
            document.getElementById('alert-title').textContent = title;
            document.getElementById('alert-message').textContent = message;
            customAlert.classList.remove('hidden');
        }

        function closeModal() {
            customAlert.classList.add('hidden');
            // Reset confirm/cancel buttons to default
            const defaultButton = document.getElementById('alert-confirm-button');
            const cancelButton = document.getElementById('alert-cancel-button');
            defaultButton.textContent = 'Understood';
            defaultButton.className = 'bg-primary-blue text-white font-semibold py-2 px-4 rounded-lg hover:bg-fiji-blue transition-colors duration-300';
            cancelButton.classList.add('hidden');
        }

        // --- Core Firebase Initialization and Auth ---
        async function initializeFirebase() {
            try {
                if (!firebaseConfigString) {
                    console.error("Firebase config is missing.");
                    showAlert("Error", "Firebase configuration missing. The app cannot start.");
                    loader.classList.add('hidden');
                    return;
                }

                const firebaseConfig = JSON.parse(firebaseConfigString);

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Set Firestore log level for debugging
                setLogLevel('Debug');

                // 1. Initial Authentication
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 2. Auth State Listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId.substring(0, 8) + '...'; // Display part of ID
                        console.log("User authenticated:", userId);
                        // Once authenticated, load the services
                        loadServices();
                    } else {
                        userId = 'unauthenticated';
                        userIdDisplay.textContent = '...';
                        console.log("User signed out or unauthenticated.");
                        loader.classList.add('hidden');
                    }
                });

            } catch (e) {
                console.error("Critical Firebase Initialization Error:", e);
                // Check for the specific API key error if the config was present
                const errorMessage = e.code === 'auth/api-key-not-valid' 
                    ? "A critical configuration error occurred: auth/api-key-not-valid. The app cannot connect to the database. Please contact support."
                    : `Initialization failed: ${e.message}`;
                
                showAlert("Critical Error", errorMessage);
                loader.classList.add('hidden');
            }
        }
        
        // --- Firestore Data Operations ---

        // Public data collection path: /artifacts/{appId}/public/data/services
        const getPublicCollectionPath = () => `artifacts/${appId}/public/data/services`;

        // The UI-state object for managing the active category
        const appState = {
            activeCategory: 'All Services'
        };

        // UI Element References
        const serviceListContainer = document.getElementById('service-list');
        const categoryButtons = document.querySelectorAll('[data-category]');
        const noServicesMessage = document.getElementById('no-services-message');
        const serviceModal = document.getElementById('service-modal');
        const serviceForm = document.getElementById('service-form');

        // Function to render the list of services
        function renderServices(services) {
            serviceListContainer.innerHTML = '';
            noServicesMessage.classList.add('hidden');
            
            // Store the full list temporarily for client-side filtering
            window.fullServicesList = services; 

            const filteredServices = services.filter(service => 
                appState.activeCategory === 'All Services' || service.category === appState.activeCategory
            );

            if (filteredServices.length === 0) {
                noServicesMessage.classList.remove('hidden');
            } else {
                filteredServices.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                filteredServices.forEach(service => {
                    const isOwner = service.creatorId === userId;
                    const card = document.createElement('div');
                    card.className = 'bg-white p-4 rounded-xl shadow-lg border-t-4 border-primary-blue hover:shadow-xl transition-shadow duration-300 relative';
                    
                    let ownerTag = '';
                    if (isOwner) {
                         ownerTag = `<span class="absolute top-0 right-0 mt-[-10px] mr-[-10px] bg-secondary-green text-white text-xs font-bold px-3 py-1 rounded-full shadow-md">YOUR SERVICE</span>`;
                    }
                    
                    const deleteButton = isOwner ? `
                        <button data-id="${service.id}" data-name="${service.name}" 
                                class="delete-btn mt-2 w-full text-sm bg-fiji-coral text-white font-semibold py-2 rounded-lg hover:bg-red-700 transition-colors duration-300 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                            Delete Listing
                        </button>
                    ` : '';

                    card.innerHTML = `
                        ${ownerTag}
                        <h3 class="text-xl font-bold text-fiji-blue">${service.name}</h3>
                        <p class="text-sm text-gray-500 mb-2">${service.category} | Listed by: ${service.creatorId.substring(0, 8)}...</p>
                        <p class="text-gray-700 mb-4">${service.description}</p>
                        <p class="text-md font-semibold text-primary-blue flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1 text-fiji-gold" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.772-1.549a1 1 0 011.06-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" />
                            </svg>
                            ${service.contact}
                        </p>
                        ${deleteButton}
                    `;
                    serviceListContainer.appendChild(card);
                });
                
                // Attach delete button listeners
                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent card interaction
                        const serviceId = e.currentTarget.getAttribute('data-id');
                        const serviceName = e.currentTarget.getAttribute('data-name');
                        showConfirmDelete(serviceId, serviceName);
                    });
                });
            }
            // Hide the initial loading indicator after first data load
            loader.classList.add('hidden');
            content.classList.remove('hidden');
        }

        // --- Data Loading and Real-time Listener ---
        function loadServices() {
            if (!db) {
                console.error("Firestore not initialized.");
                return;
            }

            const servicesCollectionRef = collection(db, getPublicCollectionPath());
            
            // Listen for real-time updates
            onSnapshot(servicesCollectionRef, (snapshot) => {
                const services = [];
                snapshot.forEach(doc => {
                    // Convert Timestamp object to ISO string if necessary, but firestore dates are objects
                    // We'll just trust the string/date format from the save function for sorting.
                    services.push({ id: doc.id, ...doc.data() });
                });
                renderServices(services);
            }, (error) => {
                console.error("Error fetching services:", error);
                showAlert("Database Error", "Could not load services list. Please check your network.");
                loader.classList.add('hidden');
            });
        }

        // --- Submission Logic ---
        async function submitService(event) {
            event.preventDefault();
            
            if (userId === 'loading...' || userId === 'unauthenticated') {
                showAlert("Error", "User is not authenticated. Cannot save service.");
                return;
            }

            const name = document.getElementById('serviceName').value.trim();
            const contact = document.getElementById('serviceContact').value.trim();
            const description = document.getElementById('serviceDescription').value.trim();
            const category = document.getElementById('serviceCategory').value;

            if (!name || !contact || !description || category === 'Select Category') {
                showAlert("Input Error", "Please fill in all fields before submitting.");
                return;
            }

            const newService = {
                name: name,
                contact: contact,
                description: description,
                category: category,
                creatorId: userId,
                // Use a simple ISO string for timestamp for consistent sorting across firestore and JS
                timestamp: new Date().toISOString(), 
            };

            try {
                // Add a new document to the services collection
                const servicesCollectionRef = collection(db, getPublicCollectionPath());
                await addDoc(servicesCollectionRef, newService);

                showAlert("Success", "Your service has been listed successfully!");
                closeServiceModal();
                serviceForm.reset();
            } catch (e) {
                console.error("Error adding document: ", e);
                showAlert("Submission Failed", "There was an error saving your service. Please try again.");
            }
        }

        // --- Deletion Logic ---
        function showConfirmDelete(serviceId, serviceName) {
             const alertTitle = `Delete Service: ${serviceName}`;
             const alertMessage = "Are you sure you want to delete this service? This action cannot be undone.";

             const performDelete = async () => {
                 try {
                     const serviceDocRef = doc(db, getPublicCollectionPath(), serviceId);
                     await deleteDoc(serviceDocRef);
                     showAlert("Deleted", "Your service was successfully removed.");
                 } catch (e) {
                     console.error("Error deleting document: ", e);
                     showAlert("Error", "Could not delete the service.");
                 }
             };

             // Use the custom alert for confirmation
             showAlert(alertTitle, alertMessage);

             // Change the button text/action for confirmation
             const defaultButton = document.getElementById('alert-confirm-button');
             const cancelButton = document.getElementById('alert-cancel-button');
             
             defaultButton.textContent = 'Yes, Delete';
             defaultButton.className = 'bg-fiji-coral text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors duration-300';
             cancelButton.classList.remove('hidden');

             // Remove old listeners and add new ones (safely by cloning)
             const defaultButtonClone = defaultButton.cloneNode(true);
             defaultButton.parentNode.replaceChild(defaultButtonClone, defaultButton);
             const cancelButtonClone = cancelButton.cloneNode(true);
             cancelButton.parentNode.replaceChild(cancelButtonClone, cancelButton);

             document.getElementById('alert-confirm-button').addEventListener('click', () => {
                 performDelete();
                 closeModal();
             }, { once: true }); // Use once: true to auto-remove

             document.getElementById('alert-cancel-button').addEventListener('click', () => {
                 closeModal();
             }, { once: true });
        }


        // --- UI Interactions ---

        // Function to update button styling
        function updateCategoryButtons(newCategory) {
             categoryButtons.forEach(btn => {
                const category = btn.getAttribute('data-category');
                btn.classList.remove('bg-primary-blue', 'text-white', 'shadow-md');
                btn.classList.add('text-gray-700', 'hover:bg-gray-100');
                
                if (category === newCategory) {
                    btn.classList.add('bg-primary-blue', 'text-white', 'shadow-md');
                    btn.classList.remove('text-gray-700', 'hover:bg-gray-100');
                }
            });
        }
        
        // Category button click handler
        categoryButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                const newCategory = e.target.getAttribute('data-category');
                if (newCategory !== appState.activeCategory) {
                    appState.activeCategory = newCategory;
                    updateCategoryButtons(newCategory);

                    // Re-render the list using the currently loaded data (if available)
                    if (window.fullServicesList) {
                        renderServices(window.fullServicesList);
                    }
                }
            });
        });

        // Modal open and close handlers
        function openServiceModal() {
            if (userId === 'loading...' || userId === 'unauthenticated') {
                 showAlert("Authentication Required", "Please wait for authentication to complete before listing a service.");
                 return;
             }
            serviceModal.classList.remove('hidden');
        }

        function closeServiceModal() {
            serviceModal.classList.add('hidden');
            serviceForm.reset();
        }

        // Attach listeners after DOM is loaded
        window.addEventListener('load', () => {
            initializeFirebase();
            
            document.getElementById('add-service-btn').addEventListener('click', openServiceModal);
            document.getElementById('close-modal-btn').addEventListener('click', closeServiceModal);
            document.getElementById('service-form').addEventListener('submit', submitService);
            
            // Custom alert close buttons (Using delegation or specific logic is safer for confirm dialog)
            document.getElementById('alert-confirm-button').addEventListener('click', closeModal);
            document.getElementById('alert-cancel-button').addEventListener('click', closeModal);
            
            // Initialize category button styling
            updateCategoryButtons(appState.activeCategory);
        });

    </script>
</head>
<body class="bg-gray-50 min-h-screen font-sans">

    <!-- Application Container -->
    <div class="max-w-4xl mx-auto p-4 md:p-6">

        <!-- Header -->
        <header class="text-center bg-white p-6 rounded-xl shadow-lg border-t-4 border-fiji-blue">
            <h1 class="text-4xl font-extrabold text-fiji-blue">Fiji Local Link</h1>
            <p class="text-sm text-gray-500 mt-2">Connecting essential services in Fiji. (User ID: <span id="user-id-display" class="font-mono text-xs text-primary-blue">Loading...</span>)</p>
        </header>
        
        <!-- Loading Indicator -->
        <div id="loading-indicator" class="text-center p-8 bg-white rounded-xl shadow-md mt-6 border-t-4 border-primary-blue font-semibold">
            <p class="text-lg text-gray-700">Connecting to Database...</p>
        </div>

        <!-- Main Content Area (Hidden until loaded) -->
        <div id="content-area" class="hidden">

            <!-- Category Filter Buttons -->
            <div class="flex flex-wrap justify-center space-x-2 md:space-x-4 mt-6 mb-6">
                <button data-category="All Services" class="category-btn bg-primary-blue text-white font-semibold py-2 px-4 rounded-full transition-all duration-200 shadow-md">All Services</button>
                <button data-category="Trades" class="category-btn text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-100 transition-all duration-200">Trades</button>
                <button data-category="Food" class="category-btn text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-100 transition-all duration-200">Food</button>
                <button data-category="Health" class="category-btn text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-100 transition-all duration-200">Health</button>
                <button data-category="Other" class="category-btn text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-100 transition-all duration-200">Other</button>
            </div>

            <!-- Service List -->
            <div id="service-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Services will be injected here -->
            </div>
            
            <!-- No Services Message -->
            <div id="no-services-message" class="hidden text-center p-8 bg-white rounded-xl shadow-md mt-6">
                 <p class="text-lg text-gray-700">No services found in this category.</p>
                 <p class="text-sm text-gray-500">Be the first to list a service!</p>
            </div>

            <!-- Floating Action Button to Add Service -->
            <button id="add-service-btn" class="fixed bottom-6 right-6 md:bottom-10 md:right-10 bg-secondary-green text-white w-14 h-14 rounded-full shadow-2xl hover:bg-green-600 transition-transform duration-300 transform hover:scale-110 flex items-center justify-center z-10">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4" />
                </svg>
            </button>
        </div>
        
    </div>

    <!-- Modal for Adding/Editing Service -->
    <div id="service-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md">
            <div class="p-6">
                <div class="flex justify-between items-center border-b pb-3 mb-4">
                    <h2 class="text-2xl font-bold text-fiji-blue">List a New Service</h2>
                    <button id="close-modal-btn" class="text-gray-400 hover:text-gray-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <form id="service-form">
                    <div class="mb-4">
                        <label for="serviceName" class="block text-sm font-medium text-gray-700 mb-1">Service Name / Title</label>
                        <input type="text" id="serviceName" name="serviceName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue">
                    </div>
                    <div class="mb-4">
                        <label for="serviceContact" class="block text-sm font-medium text-gray-700 mb-1">Contact (Phone/Email)</label>
                        <input type="text" id="serviceContact" name="serviceContact" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue">
                    </div>
                    <div class="mb-4">
                        <label for="serviceDescription" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea id="serviceDescription" name="serviceDescription" rows="3" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue"></textarea>
                    </div>
                    <div class="mb-6">
                        <label for="serviceCategory" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                        <select id="serviceCategory" name="serviceCategory" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue">
                            <option value="Select Category" disabled selected>Select Category</option>
                            <option value="Trades">Trades</option>
                            <option value="Food">Food</option>
                            <option value="Health">Health</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-secondary-green text-white font-bold py-3 rounded-lg shadow-md hover:bg-green-600 transition-colors duration-200">
                        List Service
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Custom Alert Modal (Replaces alert/confirm) -->
    <div id="custom-alert" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm">
            <div class="p-6">
                <h3 id="alert-title" class="text-xl font-bold text-fiji-blue mb-3">Alert</h3>
                <p id="alert-message" class="text-gray-700 mb-6">Message content.</p>
                <div class="flex justify-end space-x-3">
                    <button id="alert-cancel-button" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors duration-300 hidden">Cancel</button>
                    <button id="alert-confirm-button" class="bg-primary-blue text-white font-semibold py-2 px-4 rounded-lg hover:bg-fiji-blue transition-colors duration-300">Understood</button>
                </div>
            </div>
        </div>
    </div>
    
</body>
</html>



