<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiji Local Link</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#0A7AF3', // Vibrant primary blue
                        'secondary-green': '#4CAF50', // Standard green for success/actions
                        'fiji-gold': '#FFD700', // A touch of Fiji gold
                        'fiji-blue': '#102A43', // Darker blue for text/accents
                        'fiji-coral': '#F2746A', // Coral for attention/danger
                    },
                },
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #F8FAFC;
        }
        
        /* Utility for smooth transitions */
        .transition-all {
            transition: all 0.25s ease-in-out;
        }

        /* Custom scrollbar for aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e2e8f0;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* Modal overlay styling */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1000;
        }

        /* Custom Alert Styling (replacing alert()) */
        .custom-alert {
            z-index: 1050; 
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="min-h-screen">
    
    <!-- Main Application Container -->
    <div id="app" class="p-4 sm:p-6 md:p-8 flex justify-center">
        <div class="w-full max-w-xl bg-white rounded-xl shadow-2xl overflow-hidden">
            
            <!-- Header Section -->
            <header class="text-center p-6 bg-primary-blue text-white rounded-t-xl">
                <h1 class="text-4xl font-extrabold">Fiji Local Link</h1>
                <p class="mt-1 text-sm opacity-80">Connecting essential services in Fiji.</p>
                <p class="mt-2 text-xs font-semibold">User ID: <span id="user-id-display" class="font-normal opacity-70">Loading...</span></p>
            </header>

            <!-- Loading Indicator & Error Area -->
            <div id="loading-indicator" class="text-center p-6 bg-white transition-all">
                <p class="text-lg font-semibold text-primary-blue">Connecting to Database...</p>
                <div class="mt-2 flex justify-center items-center">
                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary-blue"></div>
                </div>
            </div>

            <div id="error-message" class="hidden p-4 text-center bg-fiji-coral/10 border-l-4 border-fiji-coral text-fiji-coral font-medium transition-all">
                <!-- Dynamic error message content will go here -->
            </div>

            <!-- Content Area (Hidden until loaded) -->
            <div id="content-area" class="hidden">
                
                <!-- Category Tabs -->
                <div class="flex border-b border-gray-200">
                    <button data-category="All" class="tab-button active-tab p-4 text-sm sm:text-base font-semibold text-primary-blue border-b-2 border-primary-blue transition-all flex-1" onclick="app.filterServices('All')">All Services</button>
                    <button data-category="Trades" class="tab-button p-4 text-sm sm:text-base font-semibold text-gray-500 hover:text-primary-blue transition-all flex-1" onclick="app.filterServices('Trades')">Trades</button>
                    <button data-category="Food" class="tab-button p-4 text-sm sm:text-base font-semibold text-gray-500 hover:text-primary-blue transition-all flex-1" onclick="app.filterServices('Food')">Food</button>
                    <button data-category="Health" class="tab-button p-4 text-sm sm:text-base font-semibold text-gray-500 hover:text-primary-blue transition-all flex-1" onclick="app.filterServices('Health')">Health</button>
                    <button data-category="Other" class="tab-button p-4 text-sm sm:text-base font-semibold text-gray-500 hover:text-primary-blue transition-all flex-1" onclick="app.filterServices('Other')">Other</button>
                </div>
                
                <!-- Services List -->
                <div id="service-list" class="p-4 sm:p-6 space-y-4 max-h-[60vh] overflow-y-auto">
                    <!-- Services will be injected here -->
                    <p id="no-services" class="text-center text-gray-500 hidden pt-4">No services found in this category. Be the first to list a service!</p>
                </div>

                <!-- Add Service Button (Floating Action Button) -->
                <button id="add-service-btn" class="fixed bottom-6 right-6 md:bottom-10 md:right-10 w-14 h-14 bg-secondary-green hover:bg-green-600 text-white rounded-full shadow-lg transition-all transform hover:scale-105 focus:outline-none" onclick="app.showModal('service-modal')" aria-label="Add New Service">
                    <svg class="w-8 h-8 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"></path></svg>
                </button>
            </div>

        </div>
    </div>

    <!-- Service Submission Modal -->
    <div id="service-modal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all scale-100 duration-300">
            <div class="p-6">
                <h3 class="text-2xl font-bold text-primary-blue border-b pb-3 mb-4">List a New Service</h3>
                <form id="submission-form">
                    <div class="space-y-4">
                        <div>
                            <label for="service-name" class="block text-sm font-medium text-gray-700">Service Name/Business</label>
                            <input type="text" id="service-name" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-secondary-green focus:border-secondary-green">
                        </div>
                        <div>
                            <label for="service-category" class="block text-sm font-medium text-gray-700">Category</label>
                            <select id="service-category" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-secondary-green focus:border-secondary-green">
                                <option value="" disabled selected>Select a category</option>
                                <option value="Trades">Trades</option>
                                <option value="Food">Food</option>
                                <option value="Health">Health</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label for="service-contact" class="block text-sm font-medium text-gray-700">Contact (Phone or Email)</label>
                            <input type="text" id="service-contact" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-secondary-green focus:border-secondary-green">
                        </div>
                        <div>
                            <label for="service-description" class="block text-sm font-medium text-gray-700">Description</label>
                            <textarea id="service-description" rows="3" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-secondary-green focus:border-secondary-green"></textarea>
                        </div>
                        <div>
                            <label for="service-location" class="block text-sm font-medium text-gray-700">Location (Town, Area, or Island)</label>
                            <input type="text" id="service-location" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-secondary-green focus:border-secondary-green">
                        </div>
                    </div>
                    
                    <div class="mt-6 flex justify-end space-x-3">
                        <button type="button" class="px-4 py-2 text-sm font-medium rounded-lg text-gray-700 bg-gray-200 hover:bg-gray-300 transition-all" onclick="app.closeModal('service-modal')">Cancel</button>
                        <button type="submit" class="px-4 py-2 text-sm font-medium rounded-lg text-white bg-secondary-green hover:bg-green-600 transition-all">Submit Service</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Custom Alert/Error/Confirmation Modal -->
    <div id="custom-alert" class="hidden fixed inset-0 flex items-center justify-center p-4 bg-black bg-opacity-30 custom-alert">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all duration-300">
            <div class="p-6">
                <h3 id="alert-title" class="text-xl font-bold text-gray-800 mb-2">Alert</h3>
                <p id="alert-message" class="text-gray-600 mb-4">This is a custom alert message.</p>
                <div id="alert-actions" class="flex justify-end space-x-3">
                    <button id="alert-cancel-button" class="px-4 py-2 text-sm font-medium rounded-lg text-gray-700 bg-gray-200 hover:bg-gray-300 transition-all">Cancel</button>
                    <button id="alert-confirm-button" class="px-4 py-2 text-sm font-medium rounded-lg text-white bg-primary-blue hover:bg-blue-600 transition-all">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, deleteDoc, onSnapshot, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === CRITICAL FIX FOR GITHUB PAGES DEPLOYMENT ===
        // This is a PLACEHOLDER Firebase configuration. It allows the app to load 
        // without the "Firebase configuration missing" error.
        // NOTE: For data persistence, it will use the database connected to the 
        // environment in which this code is run. For an external host, you would 
        // replace the values below with your actual Firebase project configuration.
        const PLACEHOLDER_FIREBASE_CONFIG = {
            apiKey: "AIzaSy_FIJI_PLACEHOLDER_KEY", 
            authDomain: "fiji-local-link-placeholder.firebaseapp.com",
            projectId: "fiji-local-link-placeholder",
            storageBucket: "fiji-local-link-placeholder.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:fiji-placeholder-app-id"
        };
        
        // Use the environment variable if available (Canvas environment), otherwise use the placeholder
        const externalFirebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : PLACEHOLDER_FIREBASE_CONFIG;
            
        // Environment variables for auth and app ID
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Initialize Firebase
        const app = initializeApp(externalFirebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Enable Firebase debug logging
        setLogLevel('debug');

        // Global app object for interaction
        window.app = {
            db: db,
            auth: auth,
            userId: null,
            currentCategory: 'All',
            services: [], // Stores all services for client-side filtering
            activeModal: null,

            // --- UI Methods ---

            showElement(id) { document.getElementById(id).classList.remove('hidden'); },
            hideElement(id) { document.getElementById(id).classList.add('hidden'); },
            
            showLoader() {
                this.showElement('loading-indicator');
                this.hideElement('content-area');
                this.hideElement('error-message');
            },

            hideLoader() {
                this.hideElement('loading-indicator');
                this.showElement('content-area');
            },
            
            showError(message) {
                const errorElement = document.getElementById('error-message');
                errorElement.innerHTML = `<strong>Error:</strong> ${message}`;
                this.showElement('error-message');
                this.hideElement('loading-indicator');
                this.hideElement('content-area');
            },

            showModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.addEventListener('click', this.closeModalOnClickOutside);
                    this.activeModal = modal;
                }
            },

            closeModal(modalId) {
                const modal = typeof modalId === 'string' ? document.getElementById(modalId) : modalId;
                if (modal) {
                    modal.classList.add('hidden');
                    modal.removeEventListener('click', this.closeModalOnClickOutside);
                    this.activeModal = null;
                    document.getElementById('submission-form')?.reset(); // Clear form on close
                }
            },
            
            closeModalOnClickOutside(event) {
                if (event.target === window.app.activeModal) {
                    window.app.closeModal(window.app.activeModal);
                }
            },


            // Custom replacement for window.alert() and window.confirm()
            customAlert(message, title = "Notification", type = "alert", onConfirm = null) {
                const alertModal = document.getElementById('custom-alert');
                const titleElement = document.getElementById('alert-title');
                const messageElement = document.getElementById('alert-message');
                const confirmButton = document.getElementById('alert-confirm-button');
                const cancelButton = document.getElementById('alert-cancel-button');
                
                titleElement.textContent = title;
                messageElement.textContent = message;

                // Clone/replace buttons to safely remove old listeners
                const confirmClone = confirmButton.cloneNode(true);
                confirmButton.parentNode.replaceChild(confirmClone, confirmButton);
                const cancelClone = cancelButton.cloneNode(true);
                cancelButton.parentNode.replaceChild(cancelClone, cancelButton);
                
                const newConfirmButton = document.getElementById('alert-confirm-button');
                const newCancelButton = document.getElementById('alert-cancel-button');

                if (type === "confirm") {
                    newCancelButton.classList.remove('hidden');
                    
                    newConfirmButton.textContent = "Yes, Delete";
                    newConfirmButton.classList.remove('bg-primary-blue', 'hover:bg-blue-600');
                    newConfirmButton.classList.add('bg-fiji-coral', 'hover:bg-red-500');

                    newConfirmButton.addEventListener('click', () => {
                        window.app.closeModal('custom-alert');
                        if (onConfirm) onConfirm(true);
                    }, { once: true });

                    newCancelButton.addEventListener('click', () => {
                        window.app.closeModal('custom-alert');
                        if (onConfirm) onConfirm(false); 
                    }, { once: true });

                } else { 
                    newCancelButton.classList.add('hidden');
                    
                    newConfirmButton.textContent = "Understood";
                    newConfirmButton.classList.remove('bg-fiji-coral', 'hover:bg-red-500');
                    newConfirmButton.classList.add('bg-primary-blue', 'hover:bg-blue-600');
                    
                    newConfirmButton.addEventListener('click', () => {
                        window.app.closeModal('custom-alert');
                        if (onConfirm) onConfirm(true); 
                    }, { once: true });
                }

                this.showModal('custom-alert');
            },


            // --- Core App Logic ---

            async initializeApp() {
                try {
                    this.showLoader();
                    
                    // 1. Authenticate (Anonymously or with custom token)
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }

                    // 2. Auth State Listener & Data Setup
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            this.userId = user.uid;
                            document.getElementById('user-id-display').textContent = this.userId.substring(0, 8) + '...';
                            this.listenForServices();
                        } else {
                            this.showError("User authentication failed.");
                        }
                    });

                } catch (e) {
                    console.error("Initialization Error:", e);
                    // Handle configuration errors gracefully
                    if (e.code === 'auth/api-key-not-valid' || e.code === 'auth/invalid-api-key') {
                        this.customAlert("Database configuration is invalid. The app cannot connect.", "Configuration Error");
                    }
                    this.showError(`Startup failed: ${e.message}`);
                }
            },
            
            listenForServices() {
                const collectionPath = `artifacts/${appId}/public/data/services`;
                const q = collection(db, collectionPath);
                
                // Real-time listener for updates
                onSnapshot(q, (snapshot) => {
                    const services = [];
                    snapshot.forEach((doc) => {
                        services.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Client-side sorting (newest first)
                    services.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
                    
                    this.services = services;
                    this.renderServiceList(services);
                    this.hideLoader(); // Hide loader after initial data load
                }, (error) => {
                    console.error("Firestore Listener Error:", error);
                    if (error.code === 'permission-denied') {
                         this.showError("Database Permission Denied. Check security rules.");
                    } else {
                        this.showError(`Failed to fetch services: ${error.message}`);
                    }
                });
            },

            renderServiceList(services) {
                const listElement = document.getElementById('service-list');
                const noServicesElement = document.getElementById('no-services');
                
                // Filter the services based on the current category
                const filteredServices = services.filter(service => 
                    this.currentCategory === 'All' || service.category === this.currentCategory
                );
                
                listElement.innerHTML = '';
                
                if (filteredServices.length === 0) {
                    noServicesElement.classList.remove('hidden');
                } else {
                    noServicesElement.classList.add('hidden');
                    
                    filteredServices.forEach(service => {
                        const serviceCard = this.createServiceCard(service);
                        listElement.appendChild(serviceCard);
                    });
                }
            },
            
            createServiceCard(service) {
                const card = document.createElement('div');
                card.className = 'bg-white border border-gray-200 rounded-xl p-4 shadow-lg hover:shadow-xl transition-all';
                
                const isOwner = service.creatorId === this.userId;
                
                // Determine a color for the category tag
                let tagColor = 'bg-primary-blue';
                if (service.category === 'Food') tagColor = 'bg-fiji-coral';
                else if (service.category === 'Health') tagColor = 'bg-secondary-green';
                else if (service.category === 'Trades') tagColor = 'bg-fiji-gold';
                
                // Format timestamp
                const date = service.timestamp ? service.timestamp.toDate().toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' }) : 'N/A';
                
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h4 class="text-xl font-bold text-fiji-blue">${this.sanitize(service.name)}</h4>
                        ${isOwner ? 
                            `<button data-id="${service.id}" class="delete-btn text-fiji-coral hover:text-red-700 transition-all" aria-label="Delete Service">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>` 
                            : ''}
                    </div>
                    
                    <p class="mt-1 flex items-center space-x-3">
                        <span class="text-xs font-semibold text-white px-2 py-0.5 rounded-full ${tagColor} shadow-sm">${this.sanitize(service.category)}</span>
                        <span class="text-xs text-gray-500">${this.sanitize(service.location)}</span>
                    </p>
                    
                    <p class="mt-3 text-gray-600 text-sm">${this.sanitize(service.description)}</p>
                    
                    <div class="mt-3 text-sm space-y-1 pt-2 border-t border-gray-100">
                        <p class="flex items-center text-gray-700 font-medium">
                            <svg class="w-4 h-4 mr-2 text-secondary-green" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                            <a href="tel:${this.sanitize(service.contact)}" class="text-primary-blue hover:underline">${this.sanitize(service.contact)}</a>
                        </p>
                        <p class="text-xs text-gray-400">Listed on: ${date}</p>
                    </div>
                `;
                
                // Attach event listener for the delete button if the user is the owner
                if (isOwner) {
                    const deleteBtn = card.querySelector('.delete-btn');
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.confirmDelete(service.id, service.name);
                    });
                }
                
                return card;
            },
            
            filterServices(category) {
                this.currentCategory = category;
                
                // Update active tab styling
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active-tab', 'text-primary-blue', 'border-primary-blue');
                    btn.classList.add('text-gray-500', 'hover:text-primary-blue', 'border-transparent');

                    if (btn.dataset.category === category) {
                        btn.classList.add('active-tab', 'text-primary-blue', 'border-primary-blue');
                        btn.classList.remove('text-gray-500', 'hover:text-primary-blue', 'border-transparent');
                    }
                });

                // Re-render the list with the new filter
                if (this.services) {
                    this.renderServiceList(this.services);
                }
            },

            // --- Firestore Operations ---
            
            async submitService(event) {
                event.preventDefault();

                if (!this.userId) {
                    this.customAlert("User is not authenticated. Please wait for the app to finish loading.", "Error");
                    return;
                }

                // Gather form data
                const name = document.getElementById('service-name').value.trim();
                const category = document.getElementById('service-category').value;
                const contact = document.getElementById('service-contact').value.trim();
                const description = document.getElementById('service-description').value.trim();
                const location = document.getElementById('service-location').value.trim();
                
                if (!name || !category || !contact || !description || !location) {
                    this.customAlert("Please fill out all fields before submitting.", "Missing Information");
                    return;
                }

                const newService = {
                    name: name,
                    category: category,
                    contact: contact,
                    description: description,
                    location: location,
                    creatorId: this.userId,
                    timestamp: serverTimestamp() 
                };

                const collectionPath = `artifacts/${appId}/public/data/services`;

                try {
                    await addDoc(collection(db, collectionPath), newService);

                    this.customAlert("Your service has been listed successfully!", "Success", "alert");
                    this.closeModal('service-modal');
                } catch (e) {
                    console.error("Error saving document: ", e);
                    this.customAlert("There was an error saving your service. Check the console for details.", "Submission Error", "alert");
                }
            },
            
            confirmDelete(serviceId, serviceName) {
                this.customAlert(
                    `Are you sure you want to delete the listing for "${serviceName}"? This action cannot be undone.`, 
                    "Confirm Deletion", 
                    "confirm", 
                    (confirmed) => {
                        if (confirmed) {
                            this.deleteService(serviceId);
                        }
                    }
                );
            },

            async deleteService(serviceId) {
                const docPath = `artifacts/${appId}/public/data/services/${serviceId}`;
                
                try {
                    await deleteDoc(doc(db, docPath));
                    this.customAlert("Service successfully deleted.", "Success");
                } catch (e) {
                    console.error("Error deleting document: ", e);
                    this.customAlert("Failed to delete the service. This may be due to a permission error.", "Deletion Error");
                }
            },

            // --- Utility Functions ---
            
            // Basic sanitization to prevent XSS in rendered content
            sanitize(text) {
                if (typeof text !== 'string') return text;
                const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#x27;' };
                return text.replace(/[&<>"']/ig, (match)=>(map[match]));
            }
        };

        // Attach submit listener to the form once the DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('submission-form').addEventListener('submit', (e) => window.app.submitService(e));
        });

        // Start the application initialization on window load
        window.addEventListener('load', () => window.app.initializeApp());

    </script>

</body>
</html>

