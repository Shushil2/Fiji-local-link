<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiji Local Link</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        /* Style for the floating action button */
        .fab {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .fab:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body>

    <div class="max-w-xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header -->
        <header class="text-center mb-6 p-6 bg-white rounded-xl shadow-lg">
            <h1 class="text-3xl font-extrabold text-blue-700">Fiji Local Link</h1>
            <p class="text-sm text-gray-600 mt-1">Connecting essential services in Fiji.</p>
            <p id="userIdDisplay" class="text-xs text-gray-400 mt-2 truncate">(User ID: Loading...)</p>
        </header>

        <!-- Category Tabs -->
        <div class="flex border-b border-gray-200 sticky top-0 bg-white z-10 rounded-t-xl shadow-md">
            <button data-category="Trades" class="tab-button w-1/3 py-3 text-center text-sm font-medium text-blue-700 border-b-2 border-blue-700 hover:bg-blue-50 transition duration-150">Trades</button>
            <button data-category="Food" class="tab-button w-1/3 py-3 text-center text-sm font-medium text-gray-500 border-b-2 border-transparent hover:bg-gray-50 transition duration-150">Food</button>
            <button data-category="Health" class="tab-button w-1/3 py-3 text-center text-sm font-medium text-gray-500 border-b-2 border-transparent hover:bg-gray-50 transition duration-150">Health</button>
        </div>

        <!-- Service List Container -->
        <div id="serviceList" class="space-y-4 pt-4 pb-20">
            <p id="loadingMessage" class="text-center text-gray-400 p-8">Loading services...</p>
        </div>

        <!-- Hidden Add Service Modal -->
        <div id="addServiceModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center p-4 z-20 transition-opacity duration-300">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 transform transition-all duration-300 scale-100">
                <h2 class="text-xl font-bold mb-4 text-blue-700">List a New Service</h2>
                
                <input type="text" id="serviceNameInput" placeholder="Service Name (e.g., John's Plumbing)"
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-3">
                       
                <textarea id="serviceDescriptionInput" placeholder="Description and Contact Details (Phone, Location)"
                          class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-3" rows="3"></textarea>
                          
                <select id="serviceCategoryInput"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-4">
                    <option value="" disabled selected>Select Category</option>
                    <option value="Trades">Trades</option>
                    <option value="Food">Food</option>
                    <option value="Health">Health</option>
                </select>

                <div class="flex justify-end space-x-3">
                    <button id="cancelServiceButton" class="px-4 py-2 text-sm font-medium text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                        Cancel
                    </button>
                    <button id="listServiceButton" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition">
                        List Service
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- FLOATING ACTION BUTTON (The Plus Button) -->
    <button id="addButton" aria-label="Add New Service"
            class="fab fixed bottom-8 right-8 p-5 bg-blue-600 text-white rounded-full shadow-xl hover:bg-blue-700 transition duration-150 ease-in-out z-10 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50">
        <!-- Plus Icon SVG -->
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
        </svg>
    </button>


    <!-- Firebase Initialization and Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, onSnapshot, collection, query, where, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = null;
        let currentCategory = 'Trades'; // Default category

        // Set log level for debugging
        setLogLevel('Debug');

        // --- CORE FIREBASE SETUP ---
        const initializeFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase configuration is missing.");
                    return;
                }
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authentication
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        // Display truncated User ID for design, but log full ID
                        const displayId = userId.substring(0, 10) + '...';
                        document.getElementById('userIdDisplay').textContent = `(User ID: ${displayId})`;
                        loadServices(); // Start listening for data once authenticated
                    } else {
                        // Sign in using custom token or anonymously
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
            }
        };

        // --- FIRESTORE OPERATIONS ---

        // Services are PUBLIC data shared across all users
        const getPublicCollectionRef = () => {
            if (!db) return null;
            // Path: /artifacts/{appId}/public/data/services
            return collection(db, `artifacts/${appId}/public/data/services`);
        };

        const addService = async (name, description, category) => {
            const servicesRef = getPublicCollectionRef();
            if (!servicesRef || !userId) {
                console.error("Database not ready or User ID missing.");
                return;
            }

            try {
                // Check if all fields are filled
                if (!name || !description || !category) {
                    console.error("All fields must be filled to list a service.");
                    showStatusMessage("Please fill in all details.", 'bg-red-500');
                    return;
                }

                await addDoc(servicesRef, {
                    name: name.trim(),
                    description: description.trim(),
                    category: category,
                    listerId: userId,
                    createdAt: serverTimestamp(),
                });
                console.log("Service listed successfully.");
                showStatusMessage("Service listed successfully!", 'bg-green-500');
                hideModal();

            } catch (e) {
                console.error("Error adding document: ", e);
                showStatusMessage("Error listing service. Check console.", 'bg-red-500');
            }
        };

        const loadServices = () => {
            const servicesRef = getPublicCollectionRef();
            if (!servicesRef || !userId) return; // Wait for initialization

            // Query only services matching the current category
            const q = query(
                servicesRef,
                where("category", "==", currentCategory)
            );

            // Real-time listener for the currently selected category
            onSnapshot(q, (snapshot) => {
                const serviceListElement = document.getElementById('serviceList');
                serviceListElement.innerHTML = ''; // Clear existing list
                
                document.getElementById('loadingMessage').style.display = 'none';

                if (snapshot.empty) {
                    serviceListElement.innerHTML = `
                        <div class="text-center text-gray-500 p-8 bg-white rounded-xl shadow-sm">
                            <h3 class="text-lg font-semibold mb-2">No services found in this category.</h3>
                            <p>Be the first to list a service!</p>
                        </div>
                    `;
                    return;
                }

                // Sort the services by name alphabetically (in-memory sorting)
                const sortedDocs = snapshot.docs.sort((a, b) => 
                    (a.data().name || '').localeCompare(b.data().name || '')
                );

                sortedDocs.forEach((doc) => {
                    const serviceData = doc.data();
                    const serviceElement = createServiceElement(serviceData);
                    serviceListElement.appendChild(serviceElement);
                });
                
                console.log(`Services for category '${currentCategory}' refreshed from Firestore.`);

            }, (error) => {
                console.error("Error listening to services: ", error);
                document.getElementById('serviceList').innerHTML = `<p class="text-center text-red-500 p-4">Error loading services: ${error.message}</p>`;
            });
        };
        
        // --- UI & EVENT HANDLERS ---
        
        const showStatusMessage = (message, bgColorClass) => {
            const statusDiv = document.createElement('div');
            statusDiv.className = `fixed top-4 left-1/2 transform -translate-x-1/2 p-3 rounded-lg text-white font-medium shadow-lg z-50 ${bgColorClass}`;
            statusDiv.textContent = message;
            document.body.appendChild(statusDiv);
            setTimeout(() => {
                statusDiv.remove();
            }, 3000);
        };


        const showModal = () => {
            document.getElementById('addServiceModal').classList.remove('hidden');
            document.getElementById('serviceNameInput').focus();
        };

        const hideModal = () => {
            document.getElementById('addServiceModal').classList.add('hidden');
            // Clear inputs
            document.getElementById('serviceNameInput').value = '';
            document.getElementById('serviceDescriptionInput').value = '';
            document.getElementById('serviceCategoryInput').value = currentCategory;
        };

        const handleListService = () => {
            const name = document.getElementById('serviceNameInput').value;
            const description = document.getElementById('serviceDescriptionInput').value;
            const category = document.getElementById('serviceCategoryInput').value;
            
            if (name && description && category) {
                addService(name, description, category);
            } else {
                showStatusMessage("Please fill in all fields.", 'bg-yellow-500');
            }
        };

        const createServiceElement = (data) => {
            const div = document.createElement('div');
            
            // Choose border color based on category
            let borderColor = 'border-gray-400';
            if (data.category === 'Trades') borderColor = 'border-orange-500';
            else if (data.category === 'Food') borderColor = 'border-red-500';
            else if (data.category === 'Health') borderColor = 'border-green-500';

            div.className = `p-4 bg-white rounded-xl shadow-md border-l-4 ${borderColor} transition duration-150 ease-in-out hover:shadow-lg`;
            
            div.innerHTML = `
                <h3 class="text-lg font-bold text-gray-800">${data.name}</h3>
                <p class="text-sm text-gray-600 mt-1 whitespace-pre-line">${data.description}</p>
                <div class="mt-2 text-xs font-medium text-gray-500 flex justify-between items-center">
                    <span>Category: <span class="font-semibold">${data.category}</span></span>
                    <!-- You can add a 'Call Now' button or link here -->
                </div>
            `;
            return div;
        };
        
        const changeCategory = (newCategory) => {
            if (currentCategory === newCategory) return;
            
            currentCategory = newCategory;
            
            // Update button styles
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('text-blue-700', 'border-blue-700');
                button.classList.add('text-gray-500', 'border-transparent');
                
                if (button.dataset.category === newCategory) {
                    button.classList.add('text-blue-700', 'border-blue-700');
                    button.classList.remove('text-gray-500', 'border-transparent');
                }
            });
            
            // Reload services for the new category
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('loadingMessage').textContent = `Loading ${newCategory} services...`;
            loadServices();
        };


        // --- INITIALIZATION ON WINDOW LOAD ---
        window.onload = () => {
            initializeFirebase();
            
            // Set initial tab style
            changeCategory('Trades');

            // Floating Button listener
            document.getElementById('addButton').addEventListener('click', showModal);

            // Modal listeners
            document.getElementById('cancelServiceButton').addEventListener('click', hideModal);
            document.getElementById('listServiceButton').addEventListener('click', handleListService);

            // Tab listeners
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    changeCategory(e.target.dataset.category);
                });
            });

            // Close modal when clicking outside (on the overlay)
            document.getElementById('addServiceModal').addEventListener('click', (e) => {
                if (e.target.id === 'addServiceModal') {
                    hideModal();
                }
            });
        };
    </script>
</body>
</html>

                    
