<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiji Local Link</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            min-height: 100vh;
        }
        .container {
            max-width: 480px; /* Mobile-first design: limit max width */
            margin: 0 auto;
            padding: 0;
        }
        /* Custom styles for the app container */
        .app-card {
            background-color: white;
            padding: 1rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        /* Custom styling for the "Add" button */
        .fab-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #3b82f6; /* Blue-600 */
            color: white;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s, box-shadow 0.2s;
            z-index: 10;
        }
        .fab-button:active {
            transform: scale(0.95);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body>

    <div class="container pb-20">
        <!-- Header -->
        <header class="bg-blue-600 text-white p-4 rounded-b-xl shadow-lg mb-4">
            <h1 class="text-2xl font-bold">Fiji Local Link</h1>
            <p class="text-sm opacity-90">Connecting essential services in Fiji.</p>
            <p id="user-status" class="text-xs mt-1">(User ID: Loading...)</p>
        </header>

        <!-- Category Tabs -->
        <div id="category-tabs" class="flex p-2 space-x-2 overflow-x-auto whitespace-nowrap bg-white mx-1 rounded-xl shadow-md">
            <!-- Tabs will be rendered here by JavaScript -->
        </div>

        <!-- Main Content Area -->
        <main class="p-3">
            <!-- Content will be injected here. It starts with a loading state -->
            <div id="content-area" class="mt-4">
                <div id="status-card" class="app-card flex flex-col items-center justify-center p-8 text-center min-h-[200px]">
                    <!-- Loading Spinner -->
                    <div id="loading-spinner" class="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent"></div>
                    <p id="loading-text" class="mt-4 text-gray-600">Connecting to Database...</p>
                </div>
            </div>
        </main>

        <!-- Add Service Button (Floating Action Button) -->
        <button id="add-service-btn" class="fab-button" onclick="showAddServiceModal()">
            <i class="fas fa-plus"></i>
        </button>

        <!-- Modals will be rendered here (hidden by default) -->
        <div id="modals-container"></div>
    </div>

    <script type="module">
        // Import Firebase functions from CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, limit, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase and State
        let app = null;
        let db = null;
        let auth = null;
        let currentUserId = 'Loading...';
        let isAuthReady = false;
        let currentCategory = 'All'; // Track the currently active category filter
        let servicesData = []; // Cache for all services data

        // Set log level to debug for console output
        setLogLevel('Debug');

        // --- ENVIRONMENT & CONFIGURATION HANDLING ---

        // 1. Define a Public Fallback Configuration
        // This config should ONLY be used when outside the Canvas environment and is generic.
        // NOTE: Firebase project details are usually necessary here if you want it to work outside Canvas.
        // If you only want it to work in Canvas, the logic below is fine as it will fail gracefully.
        const firebasePublicConfig = {
            // A minimal, generic config structure to prevent runtime errors
            // Replace with your actual Firebase config for full web functionality
            apiKey: "PUBLIC_FALLBACK_KEY_A", // Placeholder
            authDomain: "public-fallback.firebaseapp.com", // Placeholder
            projectId: "public-fallback-project", // Placeholder
            // ... other fields are omitted for brevity
        };

        // 2. Global Variables for Canvas Environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let firebaseConfig = null;

        if (typeof __firebase_config !== 'undefined' && __firebase_config !== null) {
            try {
                firebaseConfig = JSON.parse(__firebase_config);
            } catch (e) {
                console.error("FIREBASE CONFIG PARSE ERROR:", e);
                // Fallback to the public config if Canvas config fails to parse
                firebaseConfig = firebasePublicConfig;
            }
        } else {
            // Use public config if Canvas globals are missing (i.e., running on the web)
            console.warn("Canvas Firebase configuration missing. Using public fallback config.");
            firebaseConfig = firebasePublicConfig;
        }

        // --- PATHS ---
        // The collection path for public data (accessible to any signed-in user)
        const PUBLIC_COLLECTION_PATH = `/artifacts/${appId}/public/data/services`;

        // --- UI RENDER FUNCTIONS ---

        // Simple utility to display dynamic content
        const contentArea = document.getElementById('content-area');
        const userStatusElement = document.getElementById('user-status');
        const modalsContainer = document.getElementById('modals-container');

        // Renders a generic status/error message card
        function renderStatus(title, message, isError = false) {
            const cardClass = isError ? 'border-red-500 bg-red-50 text-red-800' : 'border-blue-500 bg-blue-50 text-blue-800';
            contentArea.innerHTML = `
                <div id="status-card" class="app-card border-2 ${cardClass} flex flex-col items-center justify-center p-8 text-center min-h-[200px]">
                    <h2 class="text-xl font-bold mb-2">${title}</h2>
                    <p class="text-sm">${message}</p>
                    ${isError ? '<button onclick="window.location.reload()" class="mt-4 bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150">Reload App</button>' : ''}
                </div>
            `;
        }

        // Renders the list of services for the current category
        function renderServices(services) {
            const filteredServices = services.filter(service => 
                currentCategory === 'All' || service.category === currentCategory
            );

            if (filteredServices.length === 0) {
                contentArea.innerHTML = `
                    <div class="app-card flex flex-col items-center justify-center p-8 text-center min-h-[200px]">
                        <i class="fas fa-clipboard-list text-5xl text-gray-400 mb-4"></i>
                        <h2 class="text-xl font-bold mb-1">No services found in this category.</h2>
                        <p class="text-gray-600">Be the first to list a service!</p>
                    </div>
                `;
                return;
            }

            contentArea.innerHTML = filteredServices.map(service => `
                <div class="app-card mb-3 p-4 hover:shadow-lg transition duration-200 cursor-pointer" onclick="showServiceDetails('${service.id}')">
                    <h3 class="text-lg font-bold text-gray-800 mb-1">${service.title}</h3>
                    <p class="text-gray-600 text-sm mb-2">${service.description.substring(0, 100)}${service.description.length > 100 ? '...' : ''}</p>
                    <div class="flex flex-wrap items-center text-xs text-gray-500">
                        <span class="bg-blue-100 text-blue-800 font-medium px-2.5 py-0.5 rounded-full mr-2">${service.category}</span>
                        ${service.posted ? `<span class="italic">Posted: ${service.posted}</span>` : ''}
                        ${service.contact ? `<span class="ml-auto text-blue-600 hover:underline"><i class="fas fa-phone mr-1"></i>Contact</span>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Renders the category tabs
        function renderCategoryTabs() {
            const categories = ['All', 'Trades', 'Food', 'Health', 'Other'];
            const tabsContainer = document.getElementById('category-tabs');
            
            tabsContainer.innerHTML = categories.map(category => `
                <button
                    class="px-4 py-2 rounded-full text-sm font-semibold transition duration-150 ease-in-out whitespace-nowrap
                    ${currentCategory === category ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}"
                    onclick="setCategoryFilter('${category}')"
                >
                    ${category}
                </button>
            `).join('');
        }
        
        // --- DATA & AUTHENTICATION ---

        window.setCategoryFilter = (category) => {
            currentCategory = category;
            renderCategoryTabs();
            renderServices(servicesData);
        };

        // --- FIREBASE INITIALIZATION & AUTHENTICATION ---

        // 1. Initialization and Authentication
        async function initFirebaseApp() {
            // Check for critical configuration issue
            if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.projectId === firebasePublicConfig.projectId) {
                renderStatus('Startup Failed', 'Firebase configuration keys are missing or invalid. This usually happens when the app is run outside a secure environment like Canvas, and you have not supplied a valid fallback config. Using the generic config structure.', true);
                return;
            }
            
            try {
                // 1. Initialize App and Services
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Set persistence to ensure reliable session management
                // NOTE: This is often complex in iframe environments, but standard practice.
                // await setPersistence(auth, browserSessionPersistence);

                // 2. Handle Authentication
                let authAttempted = false;
                
                // Use a timeout guard for custom token sign-in
                const authTimeout = new Promise((_, reject) => {
                    setTimeout(() => {
                        reject(new Error("Authentication timeout. Check network or rules."));
                    }, 5000); // 5 second timeout
                });

                if (initialAuthToken) {
                    try {
                        await Promise.race([
                            signInWithCustomToken(auth, initialAuthToken),
                            authTimeout
                        ]);
                        authAttempted = true;
                    } catch (error) {
                        console.error("Custom Token Authentication Failed:", error);
                        // If custom token fails, fall back to anonymous
                        if (error.message.includes('timeout')) {
                            console.warn("Custom token timed out. Attempting anonymous sign-in.");
                        } else {
                            console.warn("Custom token failed. Attempting anonymous sign-in.");
                        }
                    }
                }

                // If authentication wasn't successful or token wasn't provided, sign in anonymously
                if (!authAttempted || !auth.currentUser) {
                    await signInAnonymously(auth);
                }

                // 3. Setup Auth State Listener
                onAuthStateChanged(auth, (user) => {
                    isAuthReady = true;
                    if (user) {
                        currentUserId = user.uid;
                        const shortId = currentUserId.substring(0, 8) + '...';
                        userStatusElement.textContent = `(User ID: ${shortId})`;
                        console.log("Firebase initialized and user signed in:", currentUserId);
                        // Start loading data after successful sign-in
                        loadServicesInRealTime();
                    } else {
                        // This case handles sign-out or initial anonymous user status
                        currentUserId = 'Signed Out';
                        userStatusElement.textContent = `(User ID: Signed Out)`;
                        renderStatus('Authentication Failed', 'Authentication failed. Please check the console for details and ensure you have read/write permissions for public data.', true);
                    }
                });

            } catch (error) {
                console.error("FATAL FIREBASE INITIALIZATION ERROR:", error);
                renderStatus('Database Connection Error', 'Startup failed: Could not initialize Firebase. Please check your configuration and network. Details in console.', true);
            }
        }

        // 2. Data Loading
        function loadServicesInRealTime() {
            if (!db) {
                console.error("Firestore DB not initialized.");
                return;
            }

            // Reference to the public services collection
            const publicServicesRef = collection(db, PUBLIC_COLLECTION_PATH);
            const q = query(publicServicesRef, limit(50)); // Limit for performance

            // Set up real-time listener
            onSnapshot(q, 
                (snapshot) => {
                    // Success callback
                    servicesData = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        // Convert Firestore Timestamp to readable string
                        posted: doc.data().createdAt ? new Date(doc.data().createdAt.seconds * 1000).toLocaleDateString() : 'N/A'
                    }));

                    console.log("Services data updated in real-time:", servicesData.length, "services.");
                    renderServices(servicesData);
                }, 
                (error) => {
                    // Error callback
                    console.error("Error loading services in real-time:", error);
                    renderStatus('Data Error', 'Could not load services in real-time. Please check the console for details and ensure you have read/write permissions.', true);
                }
            );
        }

        // --- SERVICE DETAIL MODAL (Placeholder) ---

        window.showServiceDetails = (serviceId) => {
            const service = servicesData.find(s => s.id === serviceId);
            if (!service) return;

            // This is a placeholder for the modal display
            modalsContainer.innerHTML = `
                <div id="detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="closeModal('detail-modal')">
                    <div class="bg-white p-6 rounded-xl w-full max-w-sm shadow-2xl" onclick="event.stopPropagation()">
                        <h2 class="text-2xl font-bold text-blue-600 mb-3">${service.title}</h2>
                        <p class="text-gray-700 mb-4">${service.description}</p>
                        <div class="space-y-2 text-sm">
                            <p><span class="font-semibold">Category:</span> <span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">${service.category}</span></p>
                            <p><span class="font-semibold">Contact:</span> <a href="tel:${service.contact}" class="text-green-600 hover:text-green-700">${service.contact}</a></p>
                            <p><span class="font-semibold">Posted:</span> ${service.posted}</p>
                        </div>
                        <button class="mt-6 w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-2 rounded-lg" onclick="closeModal('detail-modal')">Close</button>
                    </div>
                </div>
            `;
            document.getElementById('detail-modal').classList.remove('hidden');
        };

        // --- ADD SERVICE MODAL (Placeholder) ---

        window.showAddServiceModal = () => {
            if (currentUserId === 'Signed Out') {
                // If authentication failed, prevent adding services
                alert("Cannot add service. Authentication failed or missing configuration keys.");
                return;
            }

            modalsContainer.innerHTML = `
                <div id="add-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="closeModal('add-modal')">
                    <form id="add-service-form" class="bg-white p-6 rounded-xl w-full max-w-sm shadow-2xl space-y-4" onclick="event.stopPropagation()">
                        <h2 class="text-2xl font-bold text-blue-600">Add New Service</h2>

                        <div>
                            <label for="title" class="block text-sm font-medium text-gray-700">Title</label>
                            <input type="text" id="title" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 border p-2">
                        </div>
                        
                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                            <textarea id="description" required rows="3" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 border p-2"></textarea>
                        </div>

                        <div>
                            <label for="category" class="block text-sm font-medium text-gray-700">Category</label>
                            <select id="category" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 border p-2">
                                <option value="" disabled selected>Select a category</option>
                                <option value="Trades">Trades</option>
                                <option value="Food">Food</option>
                                <option value="Health">Health</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div>
                            <label for="contact" cla
