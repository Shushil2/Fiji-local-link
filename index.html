<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiji Local Link</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom CSS for a clean, mobile-first look */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .app-container {
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .header-bar {
            background-color: #1e40af; /* Blue-800 */
            color: white;
            padding: 1rem;
            border-radius: 0 0 16px 16px;
        }
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        .service-list-container {
            min-height: 200px;
        }
        .category-button.active {
            background-color: #1e40af;
            color: white;
        }
        /* Modal Overlay Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            border-radius: 16px;
            width: 90%;
            max-width: 450px;
            padding: 2rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            position: relative;
        }
    </style>
</head>
<body>

<div id="app" class="app-container">
    <!-- App Header -->
    <header class="header-bar text-center p-6">
        <h1 class="text-2xl font-bold">Fiji Local Link</h1>
        <p class="text-sm">Connecting essential services in Fiji.</p>
        <p id="user-id-display" class="text-xs mt-2 opacity-80">User ID: Loading...</p>
    </header>

    <main class="p-4">
        <!-- Category Filter Buttons -->
        <div id="category-filters" class="flex flex-wrap gap-2 mb-6 -mt-2">
            <!-- Buttons will be rendered here by JS -->
        </div>

        <!-- Service List/Status Container -->
        <div id="content-area" class="service-list-container">
            <!-- Content will be rendered here by JS -->
            <div id="status-card" class="card text-center flex flex-col items-center justify-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-400"></div>
                <p class="mt-4 text-gray-600 font-semibold">Connecting to Database...</p>
            </div>
        </div>
    </main>

    <!-- Floating Action Button for adding a service -->
    <button id="add-service-btn" class="fixed bottom-6 right-6 w-14 h-14 bg-blue-700 text-white rounded-full shadow-lg hover:bg-blue-800 transition transform hover:scale-105 flex items-center justify-center text-3xl font-bold p-1">
        +
    </button>
</div>

<!-- Service Submission Modal -->
<div id="submission-modal" class="modal-overlay">
    <div class="modal-content">
        <h2 class="text-xl font-bold text-gray-800 mb-4">List a New Service</h2>
        <form id="service-form" class="space-y-4">
            <div>
                <label for="service-title" class="block text-sm font-medium text-gray-700 mb-1">Service Title (e.g., John's Plumbing)</label>
                <input type="text" id="service-title" name="title" required
                       class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label for="service-content" class="block text-sm font-medium text-gray-700 mb-1">Description & Contact Info</label>
                <textarea id="service-content" name="content" rows="4" required
                          class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
            </div>
            <div>
                <label for="service-category" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                <select id="service-category" name="category" required
                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <option value="Trades">Trades (Plumbing, Electrical, Carpentry)</option>
                    <option value="Food">Food (Catering, Takeout, Groceries)</option>
                    <option value="Health">Health (Clinics, Wellness, Pharmacy)</option>
                    <option value="Other">Other Services</option>
                </select>
            </div>
            
            <button type="submit" id="submit-button"
                    class="w-full bg-blue-700 text-white font-semibold py-3 rounded-lg hover:bg-blue-800 transition shadow-md">
                Submit Service Listing
            </button>
        </form>
        <button id="close-modal-btn" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 text-2xl" aria-label="Close Modal">
            &times;
        </button>
        <p id="form-message" class="mt-4 text-center text-sm font-medium hidden"></p>
    </div>
</div>

<script type="module">
    // --- FIREBASE IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, query, onSnapshot, where, addDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // IMPORTANT: Use the global variables provided by the Canvas environment.
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app = null;
    let db = null;
    let auth = null;
    let currentUserId = null;
    let isAuthReady = false;
    let currentCategory = 'All';

    // --- DOM REFERENCES ---
    const contentArea = document.getElementById('content-area');
    const userIdDisplay = document.getElementById('user-id-display');
    const categoryFilters = document.getElementById('category-filters');
    const addServiceBtn = document.getElementById('add-service-btn');
    const submissionModal = document.getElementById('submission-modal');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const serviceForm = document.getElementById('service-form');
    const formMessage = document.getElementById('form-message');
    const submitButton = document.getElementById('submit-button');

    const serviceCategories = ['All', 'Trades', 'Food', 'Health', 'Other'];

    // --- UTILITIES ---

    /** Renders a service item card. */
    function renderServiceCard(service) {
        // Simple sanitization to prevent XSS
        const safeTitle = service.title.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const safeContent = service.content.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const safeCategory = service.category.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

        return `
            <div class="card p-4 flex flex-col md:flex-row justify-between items-start md:items-center">
                <div class="flex-grow">
                    <h2 class="text-lg font-bold text-gray-800">${safeTitle}</h2>
                    <p class="text-sm text-gray-600 mt-1">${safeContent}</p>
                </div>
                <div class="mt-3 md:mt-0 md:ml-4 text-right flex-shrink-0">
                    <span class="inline-block px-3 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">${safeCategory}</span>
                    <p class="text-xs text-gray-400 mt-1">Posted: ${service.timestamp ? new Date(service.timestamp).toLocaleDateString() : 'N/A'}</p>
                </div>
            </div>
        `;
    }

    /** Renders status/error messages to the user using a custom modal style. */
    function renderStatus(type, message) {
        const icon = type === 'error' ? '‚ùå' : (type === 'loading' ? 'üîÑ' : '‚úÖ');
        const color = type === 'error' ? 'bg-red-50 border-red-400 text-red-800' : 'bg-white border-gray-200 text-gray-800';
        
        // Only update contentArea if it's currently showing a status/loading screen
        // or if it's an error. We don't want to overwrite the service list with a status.
        if (type === 'error' || contentArea.querySelector('#status-card')) {
             contentArea.innerHTML = `
                <div id="status-card" class="card ${color} border text-center py-10">
                    <div class="text-4xl mb-4">${icon}</div>
                    <h3 class="text-xl font-semibold">${type === 'error' ? 'Error' : 'Status'}</h3>
                    <p class="mt-2 text-sm">${message}</p>
                    ${type === 'error' ? `
                        <button onclick="window.location.reload()" class="mt-4 bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition">
                            Reload App
                        </button>` : ''}
                </div>
            `;
        }
    }

    /** Renders the list of services for the current category. */
    function renderServices(services) {
        if (!isAuthReady) return; 

        // Remove status message if it exists
        const statusEl = document.getElementById('status-card');
        if (statusEl) statusEl.remove();
        
        if (services.length === 0) {
            contentArea.innerHTML = `
                <div class="card text-center py-10 text-gray-500">
                    <div class="text-4xl mb-4">üìã</div>
                    <h3 class="text-xl font-semibold">No services found in this category.</h3>
                    <p class="mt-2">Be the first to list a service!</p>
                </div>
            `;
            return;
        }

        contentArea.innerHTML = services.map(renderServiceCard).join('');
    }

    /** Renders the category filter buttons. */
    function setupCategoryFilters() {
        categoryFilters.innerHTML = serviceCategories.map(category => `
            <button class="category-button px-4 py-2 text-sm font-medium rounded-full transition ${category === currentCategory ? 'active' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}" 
                    data-category="${category}">
                ${category}
            </button>
        `).join('');

        categoryFilters.addEventListener('click', (event) => {
            const button = event.target.closest('.category-button');
            if (button) {
                const newCategory = button.dataset.category;
                if (newCategory !== currentCategory) {
                    currentCategory = newCategory;
                    // Re-render buttons for active state change
                    setupCategoryFilters(); 
                    // Re-attach the snapshot listener for the new filter
                    setupRealtimeListener();
                }
            }
        });
    }

    // --- FIREBASE DATA OPERATIONS ---

    /** Sets up the Real-Time Data Listener (Snapshot). */
    function setupRealtimeListener() {
        if (!db || !isAuthReady) {
            console.warn("Database not ready or User not authenticated, cannot set up listener.");
            return;
        }

        // Only show loading if the list is empty (avoids flashing while existing data is shown)
        if (contentArea.children.length === 0 || contentArea.querySelector('#status-card')) {
             renderStatus('loading', `Loading services for: ${currentCategory}`);
        }

        // Public data is stored in the 'services' collection under the public path.
        const collectionPath = `artifacts/${appId}/public/data/services`;
        const servicesCollectionRef = collection(db, collectionPath);
        
        let q;
        if (currentCategory === 'All') {
            q = servicesCollectionRef;
        } else {
            q = query(servicesCollectionRef, where('category', '==', currentCategory));
        }

        // Listen for real-time changes to the filtered collection
        onSnapshot(q, (snapshot) => {
            try {
                const services = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    services.push({ 
                        id: doc.id, 
                        title: data.title || 'Untitled Service',
                        content: data.content || 'No description provided.',
                        category: data.category || 'Other',
                        timestamp: data.timestamp || Date.now()
                    });
                });
                renderServices(services);
                console.log(`Successfully loaded ${services.length} services for category: ${currentCategory}.`);
            } catch (e) {
                console.error("Error processing real-time data snapshot:", e);
                renderStatus('error', "Could not process services in real-time. Please check the console.");
            }
        }, (error) => {
            console.error("Firebase Snapshot Error:", error);
            // This usually indicates a permissions issue (security rules)
            renderStatus('error', "DATABASE CONNECTION ERROR. Could not load services. Please check security rules and console logs.");
        });
    }

    /** Submits a new service to Firestore. */
    async function submitNewService(formData) {
        if (!db || !isAuthReady) {
            console.error("Cannot submit service: Database not ready or User not authenticated.");
            displayFormMessage('error', 'Cannot submit: Please reload and ensure you are connected.', true);
            return;
        }

        submitButton.disabled = true;
        submitButton.textContent = 'Submitting...';
        displayFormMessage('loading', 'Saving your service to the database...');

        try {
            const collectionPath = `artifacts/${appId}/public/data/services`;
            const servicesCollectionRef = collection(db, collectionPath);

            await addDoc(servicesCollectionRef, {
                title: formData.title,
                content: formData.content,
                category: formData.category,
                userId: currentUserId, // Store the user ID for security rules validation
                timestamp: Date.now() // Add timestamp for sorting/display
            });

            displayFormMessage('success', 'Service submitted successfully! Closing in 3 seconds.');
            serviceForm.reset();
            
            setTimeout(() => {
                submissionModal.style.display = 'none';
                displayFormMessage('', ''); // Clear message
            }, 3000);


        } catch (error) {
            console.error("Error adding document: ", error);
            displayFormMessage('error', `Submission failed. Error: ${error.message}`, true);
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'Submit Service Listing';
        }
    }

    // --- MODAL AND EVENT HANDLERS ---
    
    /** Displays a message within the form. */
    function displayFormMessage(type, message, isError = false) {
        formMessage.textContent = message;
        formMessage.className = 'mt-4 text-center text-sm font-medium'; // Reset classes
        formMessage.classList.remove('hidden');

        if (type === 'error' || isError) {
            formMessage.classList.add('text-red-600');
        } else if (type === 'success') {
            formMessage.classList.add('text-green-600');
        } else if (type === 'loading') {
             formMessage.classList.add('text-gray-600');
        }
    }


    /** Handles the form submission. */
    function handleFormSubmit(event) {
        event.preventDefault();
        const formData = {
            title: document.getElementById('service-title').value.trim(),
            content: document.getElementById('service-content').value.trim(),
            category: document.getElementById('service-category').value,
        };
        if (formData.title && formData.content && formData.category) {
            submitNewService(formData);
        } else {
            displayFormMessage('error', 'Please fill out all fields.', true);
        }
    }

    /** Sets up all general event listeners. */
    function setupEventListeners() {
        // 1. Plus button opens the modal
        addServiceBtn.addEventListener('click', () => {
            if (isAuthReady) {
                submissionModal.style.display = 'flex';
                serviceForm.reset(); // Clear previous data
                formMessage.classList.add('hidden'); // Hide messages
            } else {
                renderStatus('error', 'Connection not ready. Please wait a moment and try again.');
            }
        });

        // 2. Close button closes the modal
        closeModalBtn.addEventListener('click', () => {
            submissionModal.style.display = 'none';
        });

        // 3. Submitting the form
        serviceForm.addEventListener('submit', handleFormSubmit);
    }


    // --- FIREBASE INITIALIZATION & AUTHENTICATION ---

    /** Initializes Firebase services and performs authentication asynchronously. */
    async function initializeAndAuthenticate() {
        try {
            renderStatus('loading', 'Initializing Firebase services...');
            
            if (!firebaseConfigString) {
                throw new Error("Missing Firebase configuration. Check if this is running in a secure environment.");
            }
            
            // 1. Initialize App & Services
            const firebaseConfig = JSON.parse(firebaseConfigString);
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('debug'); // Enable detailed Firebase logging

            // 2. Handle Authentication
            let user;
            if (initialAuthToken) {
                // Wait for custom token sign-in
                const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                user = userCredential.user;
            } else {
                // Fallback to anonymous sign-in
                const userCredential = await signInAnonymously(auth);
                user = userCredential.user;
            }

            if (user) {
                currentUserId = user.uid;
                isAuthReady = true;
                userIdDisplay.textContent = `User ID: ${currentUserId}`;
                
                // 3. Setup UI and Data Listener
                setupCategoryFilters();
                setupRealtimeListener();
                setupEventListeners(); // <-- NOW WE ATTACH ALL LISTENERS
            } else {
                 throw new Error("Authentication failed: User object is null.");
            }

        } catch (error) {
            console.error("FATAL INITIALIZATION ERROR:", error);
            // Display a user-friendly error message
            renderStatus('error', `Startup failed: ${error.message}. Please check console for configuration details.`);
        }
    }

    // Start the process immediately when the window loads.
    win
