<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiji Local Link</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#0A4A7F', // Fiji Blue
                        'secondary-green': '#4CAF50', // Standard success green
                        'fiji-gold': '#FFD700', // Gold accent
                        'fiji-blue': '#102A4A',
                        'fiji-coral': '#F27272', // Coral accent
                    },
                },
            }
        }
    </script>
    <style>
        /* Import Inter font from Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f9;
        }

        /* Custom styling for the tab/button active state */
        .tab-active {
            border-bottom: 3px solid #0A4A7F;
            color: #0A4A7F;
            font-weight: 600;
            transition: transform 0.2s;
        }

        /* Modal backdrop and overlay styling */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        /* Custom styles for the plus button */
        .plus-button {
            transition: opacity 0.3s, transform 0.3s;
        }

        .plus-button:hover {
            opacity: 0.9;
            transform: scale(1.05);
        }
        
        /* Loading spinner */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #0A4A7F; /* Primary Blue */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen">
    <div id="app" class="max-w-xl mx-auto p-4 md:p-6">
        <!-- Application Container -->
        
        <!-- Header Card -->
        <div class="header-card bg-white p-6 rounded-xl shadow-lg mb-6">
            <h1 class="text-3xl font-extrabold text-primary-blue text-center">Fiji Local Link</h1>
            <p class="text-sm text-gray-500 mt-1 text-center">Connecting essential services in Fiji. (User ID: <span id="user-id-display" class="font-mono text-xs">Loading...</span>)</p>
        </div>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="text-center p-8 bg-white rounded-xl shadow-lg mb-6 flex flex-col items-center justify-center">
            <div class="loader mb-3"></div>
            <p class="text-primary-blue font-semibold">Connecting to Database...</p>
        </div>

        <!-- Error Container -->
        <div id="error-container" class="hidden text-center p-8 bg-red-100 rounded-xl shadow-lg mb-6 border-l-4 border-red-500 text-red-700">
            <p class="font-bold mb-2">Error: <span id="error-message"></span></p>
            <p class="text-sm">Please refresh the page or check the console for details.</p>
        </div>

        <!-- Main Content Area (Hidden until loaded) -->
        <div id="content-area" class="hidden">
            
            <!-- Category Tabs -->
            <div id="tab-container" class="flex justify-between space-x-2 bg-white p-3 rounded-xl shadow-lg mb-6 overflow-x-auto whitespace-nowrap">
                <!-- Tabs will be rendered here by JavaScript -->
            </div>

            <!-- Service List -->
            <div id="service-list" class="space-y-4">
                <!-- Services will be rendered here by JavaScript -->
                <div id="empty-state" class="text-center p-8 bg-white rounded-xl shadow-lg text-gray-500">
                    <p class="text-lg font-semibold mb-1">No services found in this category.</p>
                    <p class="text-sm">Be the first to list a service!</p>
                </div>
            </div>

            <!-- Add Service Button (Floating Action Button) -->
            <button id="add-service-btn" class="plus-button fixed bottom-6 right-6 md:right-8 w-14 h-14 bg-primary-blue text-white rounded-full shadow-2xl flex items-center justify-center text-3xl z-30">
                +
            </button>
        </div>
        
        <!-- MODAL PLACEHOLDER (Will be injected by JS) -->
    </div>
    
    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, arrayUnion, arrayRemove, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase logging for debug purposes (can be removed in production)
        setLogLevel('Debug');

        // --- GLOBAL VARIABLES & CONFIGURATION ---

        // =========================================================================
        // IMPORTANT: REPLACE THIS PLACEHOLDER CONFIG WITH YOUR ACTUAL FIREBASE CONFIG
        // This is only used if the app runs outside the Canvas environment (e.g., GitHub Pages).
        // Get this config from your Firebase Project settings > Web App > Config.
        // =========================================================================
        const FALLBACK_FIREBASE_CONFIG = {
            apiKey: "YOUR_API_KEY_HERE", // <-- 1. REPLACE THIS with your actual API Key
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com", // <-- 2. REPLACE THIS with your Auth Domain
            projectId: "YOUR_PROJECT_ID", // <-- 3. REPLACE THIS with your Project ID
            storageBucket: "YOUR_PROJECT_ID.appspot.com", // <-- 4. REPLACE THIS with your Storage Bucket (optional but recommended)
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID", // <-- 5. REPLACE THIS with your Sender ID (optional but recommended)
            appId: "YOUR_APP_ID_HERE" // <-- 6. REPLACE THIS with your App ID
        };
        
        const FALLBACK_APP_ID = 'fiji-local-link-v1'; // Default App ID for public deployment
        const FALLBACK_AUTH_TOKEN = null; // No custom token on public deployment
        
        let firebaseConfig;
        let appId;
        let initialAuthToken;

        // Determine environment and load configuration
        try {
            // Attempt to load configurations provided by the Canvas environment
            firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : FALLBACK_FIREBASE_CONFIG;
            appId = typeof __app_id !== 'undefined' ? __app_id : FALLBACK_APP_ID;
            initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : FALLBACK_AUTH_TOKEN;
            
            // Critical check for manual configuration if running outside Canvas
            if (firebaseConfig.apiKey === 'YOUR_API_KEY_HERE' && typeof __firebase_config === 'undefined') {
                 // This error is caught and displayed by the catch block
                 throw new Error("Missing manual Firebase configuration.");
            }
        } catch (error) {
            console.error("Configuration Error:", error);
            showError("Firebase configuration missing. Did you replace the placeholder values in the HTML file?", true);
            return; // Halt execution if config is critically missing
        }

        // --- INITIALIZE FIREBASE ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // --- GLOBAL STATE ---
        let userId = null;
        let isAuthReady = false;
        let currentCategory = 'All Services';
        const categories = ['All Services', 'Trades', 'Food', 'Health', 'Other'];
        let servicesData = []; // Cache for all fetched services

        // --- DOM ELEMENTS ---
        const $contentArea = document.getElementById('content-area');
        const $serviceList = document.getElementById('service-list');
        const $emptyState = document.getElementById('empty-state');
        const $tabContainer = document.getElementById('tab-container');
        const $loadingIndicator = document.getElementById('loading-indicator');
        const $errorContainer = document.getElementById('error-container');
        const $errorMessage = document.getElementById('error-message');
        const $userIdDisplay = document.getElementById('user-id-display');
        const $addServiceBtn = document.getElementById('add-service-btn');

        // --- UTILITY FUNCTIONS ---
        
        /** Shows a modal error message and updates the error container */
        function showError(message, isCritical = true) {
            console.error(message);
            $loadingIndicator.classList.add('hidden');
            $contentArea.classList.add('hidden');
            
            $errorMessage.textContent = message;
            $errorContainer.classList.remove('hidden');
            
            // Show a custom modal for the error
            app.showModal({
                id: 'criticalErrorModal',
                title: isCritical ? 'Critical Error' : 'Data Error',
                content: `<p>${message}</p>`,
                buttons: [{ text: 'Understood', class: isCritical ? 'bg-red-500' : 'bg-primary-blue' }]
            });
        }
        
        /** Hides the error container */
        function hideError() {
             $errorContainer.classList.add('hidden');
        }

        /** Clears and populates the service list based on the current category */
        function renderServices() {
            $serviceList.innerHTML = '';
            
            let filteredServices = servicesData;
            
            if (currentCategory !== 'All Services') {
                filteredServices = servicesData.filter(service => service.category === currentCategory);
            }
            
            if (filteredServices.length === 0) {
                $emptyState.classList.remove('hidden');
                $serviceList.appendChild($emptyState);
            } else {
                $emptyState.classList.add('hidden');
                filteredServices.forEach(service => {
                    $serviceList.appendChild(createServiceCard(service));
                });
            }
            
            // Ensure the main content is visible now that data (or lack thereof) is rendered
            $loadingIndicator.classList.add('hidden');
            $contentArea.classList.remove('hidden');
        }

        /** Creates a card element for a single service */
        function createServiceCard(service) {
            const card = document.createElement('div');
            card.className = 'service-card bg-white p-4 rounded-xl shadow-md border-l-4 border-primary-blue hover:shadow-lg transition-shadow duration-300';
            card.dataset.id = service.id;

            const isOwner = service.ownerId === userId;
            const ownerBadge = isOwner 
                ? '<span class="text-xs font-semibold text-white bg-primary-blue px-2 py-0.5 rounded-full ml-2">You</span>' 
                : '';
            
            // Format the display name (e.g., user-a1b2...)
            const displayName = service.ownerId ? `user-${service.ownerId.substring(0, 4)}` : 'Anonymous';

            const controls = isOwner 
                ? `
                <div class="flex space-x-2 mt-2 pt-2 border-t border-gray-100">
                    <button data-id="${service.id}" data-action="delete" class="text-xs text-red-600 hover:text-red-800 font-medium">Delete</button>
                </div>
                `
                : '';

            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">${service.name}</h2>
                        <span class="text-xs font-semibold text-white bg-fiji-coral px-3 py-1 rounded-full">${service.category}</span>
                    </div>
                </div>
                <p class="text-sm text-gray-600 mt-2">${service.description}</p>
                <div class="mt-3 text-right">
                    <p class="text-xs text-gray-400">Listed by: ${displayName} ${ownerBadge}</p>
                </div>
                ${controls}
            `;
            
            // Add event listener for delete button if owner
            if (isOwner) {
                const deleteButton = card.querySelector('[data-action="delete"]');
                deleteButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    app.confirmDelete(service.id, service.name);
                });
            }

            return card;
        }

        /** Renders the category tabs */
        function renderTabs() {
            $tabContainer.innerHTML = '';
            categories.forEach(category => {
                const button = document.createElement('button');
                button.textContent = category;
                button.className = `px-4 py-2 text-sm md:text-base rounded-lg transition-colors duration-200 ${category === currentCategory ? 'tab-active text-primary-blue' : 'text-gray-500 hover:text-primary-blue'}`;
                button.addEventListener('click', () => {
                    currentCategory = category;
                    renderTabs(); // Re-render tabs to update active state
                    renderServices(); // Re-render services based on new category
                });
                $tabContainer.appendChild(button);
            });
        }
        
        // --- DATABASE FUNCTIONS ---

        /** Sets up the real-time listener for services */
        function listenForServices() {
            if (!isAuthReady) {
                return;
            }
            
            const servicesCollectionRef = collection(db, `artifacts/${appId}/public/data/services`);
            
            // Query to listen for all services, sorted by creation time
            const q = query(servicesCollectionRef, orderBy('createdAt', 'desc'));

            onSnapshot(q, (snapshot) => {
                const newServices = [];
                snapshot.forEach((doc) => {
                    newServices.push({ id: doc.id, ...doc.data() });
                });
                
                // Update cached data
                servicesData = newServices;
                
                // Re-render UI
                renderServices();
            }, (error) => {
                console.error("Firestore Listen Error:", error);
                // Show a non-critical error for data loading failure
                showError(`Could not load services. (Error: ${error.code})`, false);
            });
        }

        /** Handles service submission */
        async function submitService(event) {
            event.preventDefault();
            
            // Get data from the form (which is inside the modal)
            const serviceName = document.getElementById('service-name').value.trim();
            const category = document.getElementById('category').value;
            const description = document.getElementById('description').value.trim();
            
            if (!userId || userId === 'NOT_AUTHENTICATED' || !isAuthReady) {
                app.showAlert('Error', 'Authentication required to list a service.');
                return;
            }
            
            if (!serviceName || !description) {
                app.showAlert('Validation Error', 'Please fill out all fields.');
                return;
            }
            
            const newService = {
                name: serviceName,
                category: category,
                description: description,
                ownerId: userId,
                // ownerName is now derived from ID for consistency
                createdAt: new Date(), 
            };

            try {
                const servicesCollectionRef = collection(db, `artifacts/${appId}/public/data/services`);
                await addDoc(servicesCollectionRef, newService);
                
                app.showAlert('Success', 'Your service has been listed successfully!');
                app.closeModal('serviceModal');
                
                // Clear the form
                document.getElementById('service-name').value = '';
                document.getElementById('description').value = '';
                
            } catch (e) {
                console.error("Error saving document: ", e);
                app.showAlert('Submission Failed', `Error: ${e.message}. Check console for details.`);
            }
        }
        
        /** Handles service deletion */
        async function deleteService(serviceId) {
            if (!userId || !isAuthReady || userId === 'NOT_AUTHENTICATED') {
                 app.showAlert('Error', 'You must be logged in to delete services.');
                 return;
            }
            
            try {
                const serviceDocRef = doc(db, `artifacts/${appId}/public/data/services`, serviceId);
                // The actual security check is done by Firestore rules, but this is a good client-side safeguard
                const docSnapshot = await getDoc(serviceDocRef);
                
                if (docSnapshot.exists() && docSnapshot.data().ownerId === userId) {
                    await deleteDoc(serviceDocRef);
                    app.showAlert('Deleted', 'Service successfully removed.');
                } else {
                    app.showAlert('Permission Denied', 'You can only delete services you have listed.');
                }
            } catch (e) {
                console.error("Error deleting document: ", e);
                app.showAlert('Error', `Could not delete the service. (Error: ${e.code})`);
            }
        }

        // --- AUTHENTICATION & INITIALIZATION ---
        
        async function initFirebaseApp() {
            
            $userIdDisplay.textContent = 'Authenticating...';
            $loadingIndicator.classList.remove('hidden');
            $contentArea.classList.add('hidden');
            
            try {
                // Sign in logic
                if (initialAuthToken && initialAuthToken !== 'null') {
                    // Use Canvas Custom Token (for Canvas environment)
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Fallback to Anonymous Sign In (for public deployment)
                    await signInAnonymously(auth);
                }
                
                // Set up auth state change listener (This is where the app truly initializes)
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        // Display a truncated ID for brevity in the UI
                        $userIdDisplay.textContent = userId.substring(0, 15) + '...'; 
                        isAuthReady = true;
                        
                        // Start listening for data once authenticated
                        listenForServices(); 
                        renderTabs();
                        
                        hideError(); 
                        
      