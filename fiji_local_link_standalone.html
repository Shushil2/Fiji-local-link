<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiji Local Link</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#0A7AFF',
                        'secondary-green': '#34C759',
                        'fiji-gold': '#FFD700',
                        'fiji-blue': '#102A43',
                        'fiji-coral': '#F27059',
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .tab-active { border-bottom: 3px solid #0A7AFF; color: #0A7AFF; font-weight: 600; }
        .card { transition: transform 0.2s; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.6); }
        /* Custom alert/modal styling */
        .custom-alert {
            z-index: 1000;
            transition: opacity 0.3s, transform 0.3s;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Main Application Container -->
    <div id="app" class="max-w-4xl mx-auto p-4 md:p-6">
        <!-- Header -->
        <header class="text-center mb-6 bg-white p-4 rounded-xl shadow-lg">
            <h1 class="text-3xl font-extrabold text-fiji-blue">Fiji Local Link</h1>
            <p class="text-sm text-gray-500 mt-1">Connecting essential services in Fiji. (User ID: <span id="user-id-display" class="font-mono text-xs bg-gray-100 p-1 rounded">Loading...</span>)</p>
        </header>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="text-center p-8 bg-white rounded-xl shadow-md">
            <div class="animate-spin inline-block w-8 h-8 border-4 border-primary-blue border-t-transparent rounded-full"></div>
            <p class="mt-4 text-primary-blue font-semibold">Connecting to Database...</p>
        </div>

        <!-- Content Area (Hidden until loaded) -->
        <div id="content-area" class="hidden">

            <!-- Tab Navigation -->
            <nav class="flex justify-between items-center space-x-2 p-2 bg-white rounded-t-xl shadow-md">
                <button onclick="app.setCategory('All')" class="tab-button flex-1 py-3 px-1 text-center text-gray-600 focus:outline-none">All Services</button>
                <button onclick="app.setCategory('Trades')" class="tab-button flex-1 py-3 px-1 text-center text-gray-600 focus:outline-none">Trades</button>
                <button onclick="app.setCategory('Food')" class="tab-button flex-1 py-3 px-1 text-center text-gray-600 focus:outline-none">Food</button>
                <button onclick="app.setCategory('Health')" class="tab-button flex-1 py-3 px-1 text-center text-gray-600 focus:outline-none">Health</button>
                <button onclick="app.setCategory('Other')" class="tab-button flex-1 py-3 px-1 text-center text-gray-600 focus:outline-none">Other</button>
            </nav>

            <!-- Service List -->
            <div id="service-list" class="grid grid-cols-1 gap-4 mt-4">
                <!-- Services will be injected here -->
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="hidden text-center p-12 bg-white rounded-xl shadow-md mt-4">
                <p class="text-xl text-gray-500 font-semibold">No services found in this category.</p>
                <p class="text-gray-400 mt-2">Be the first to list a service!</p>
            </div>

            <!-- Floating Button -->
            <button onclick="app.openModal('serviceModal')" class="fixed bottom-4 right-4 md:bottom-6 md:right-6 bg-primary-blue text-white p-4 rounded-full shadow-2xl hover:bg-opacity-90 transition transform hover:scale-105 focus:outline-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                </svg>
                <span class="sr-only">Add Service</span>
            </button>
        </div>
    </div>

    <!-- Service Submission Modal -->
    <div id="serviceModal" class="fixed inset-0 hidden modal-overlay items-center justify-center p-4" onclick="if(event.target.id === 'serviceModal') app.closeModal('serviceModal')">
        <div class="bg-white w-full max-w-md p-6 rounded-xl shadow-2xl transform transition-all">
            <h2 class="text-2xl font-bold text-fiji-blue mb-4">List Your Service Now</h2>
            <form id="serviceForm" onsubmit="app.submitService(event)">
                
                <div class="mb-4">
                    <label for="serviceName" class="block text-sm font-medium text-gray-700">Service/Business Name</label>
                    <input type="text" id="serviceName" required class="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-primary-blue focus:border-primary-blue">
                </div>
                
                <div class="mb-4">
                    <label for="category" class="block text-sm font-medium text-gray-700">Category</label>
                    <select id="category" required class="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-primary-blue focus:border-primary-blue bg-white">
                        <option value="">Select a Category</option>
                        <option value="Trades">Trades (Plumbing, Electrical, Carpentry)</option>
                        <option value="Food">Food (Catering, Restaurants, Delivery)</option>
                        <option value="Health">Health (Doctor, Pharmacy, Fitness)</option>
                        <option value="Other">Other (Retail, Transport, IT)</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label for="contact" class="block text-sm font-medium text-gray-700">Contact Number/Email</label>
                    <input type="text" id="contact" required class="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-primary-blue focus:border-primary-blue" placeholder="e.g., 777-XXXX or email@example.com">
                </div>
                
                <div class="mb-6">
                    <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea id="description" rows="3" required class="mt-1 block w-full border border-gray-300 rounded-lg p-3 shadow-sm focus:ring-primary-blue focus:border-primary-blue"></textarea>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="app.closeModal('serviceModal')" class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-white bg-primary-blue rounded-lg hover:bg-opacity-90 transition">
                        <span id="modal-loader" class="hidden animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></span>
                        Save Service
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="customAlert" class="custom-alert fixed inset-0 hidden modal-overlay items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm p-6 rounded-xl shadow-2xl transform scale-95">
            <h3 id="alertTitle" class="text-xl font-bold text-fiji-blue mb-3">Alert</h3>
            <p id="alertMessage" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end">
                <button type="button" onclick="app.closeModal('customAlert')" class="px-4 py-2 text-white bg-primary-blue rounded-lg hover:bg-opacity-90 transition">OK</button>
            </div>
        </div>
    </div>


    <!-- Firebase and App Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'fiji-local-link-default';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Ensure firebase config exists before initializing
        if (!firebaseConfig) {
            console.error("Firebase configuration is missing. Cannot initialize app.");
            document.getElementById('loading-indicator').innerHTML = '<p class="text-red-600 font-semibold">Error: Firebase configuration missing.</p>';
        } else {
            // Initialize Firebase
            setLogLevel('Debug');
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            
            // Global App State and Functions
            window.app = {
                db: db,
                auth: auth,
                userId: null,
                currentCategory: 'All',
                services: [],
                
                // Helper to display custom alert modal
                showAlert: function(title, message) {
                    document.getElementById('alertTitle').textContent = title;
                    document.getElementById('alertMessage').textContent = message;
                    document.getElementById('customAlert').classList.remove('hidden');
                    document.getElementById('customAlert').classList.add('flex');
                },

                // Helper to close any modal
                closeModal: function(id) {
                    const modal = document.getElementById(id);
                    if (modal) {
                        modal.classList.remove('flex');
                        modal.classList.add('hidden');
                    }
                },

                // Helper to open any modal
                openModal: function(id) {
                    const modal = document.getElementById(id);
                    if (modal) {
                        modal.classList.remove('hidden');
                        modal.classList.add('flex');
                    }
                },

                // Authentication and Initialization
                initializeAuth: async function() {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            // Fallback to anonymous sign-in if no custom token is provided
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Auth initialization failed:", error);
                        // Fallback to anonymous sign-in in case of custom token failure
                        await signInAnonymously(auth);
                    }
                    
                    // Set up auth state change listener (critical for setting userId)
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            this.userId = user.uid;
                            document.getElementById('user-id-display').textContent = this.userId.substring(0, 8) + '...';
                            this.startDataListener();
                            document.getElementById('loading-indicator').classList.add('hidden');
                            document.getElementById('content-area').classList.remove('hidden');
                            this.updateTabs();
                        } else {
                            // This case should not be reached often due to the sign-in attempts above
                            console.warn("User is signed out or anonymous sign-in failed.");
                            document.getElementById('loading-indicator').innerHTML = '<p class="text-red-600 font-semibold">Error: Auth failed. Please try reloading.</p>';
                        }
                    });
                },

                // Firestore Listener
                startDataListener: function() {
                    // Public data path: /artifacts/{appId}/public/data/{your_collection_name}
                    const publicServicesCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'services');
                    
                    // Listen for real-time updates
                    onSnapshot(publicServicesCollectionRef, (snapshot) => {
                        this.services = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        console.log("Services updated:", this.services.length);
                        this.renderServices();
                    }, (error) => {
                        console.error("Error fetching services:", error);
                        this.showAlert("Connection Error", "Could not fetch services in real-time. Please check your network.");
                        document.getElementById('loading-indicator').classList.add('hidden');
                        document.getElementById('content-area').classList.remove('hidden');
                    });
                },
                
                // UI Functions
                updateTabs: function() {
                    document.querySelectorAll('.tab-button').forEach(button => {
                        button.classList.remove('tab-active');
                        button.classList.add('border-b-2', 'border-transparent');
                        if (button.textContent.includes(this.currentCategory) || 
                            (this.currentCategory === 'All' && button.textContent.includes('All Services'))) {
                            button.classList.add('tab-active');
                            button.classList.remove('border-transparent');
                        }
                    });
                },
                
                setCategory: function(category) {
                    this.currentCategory = category;
                    this.updateTabs();
                    this.renderServices();
                },

                renderServices: function() {
                    const listContainer = document.getElementById('service-list');
                    const emptyState = document.getElementById('empty-state');
                    listContainer.innerHTML = '';
                    
                    let filteredServices = this.services;

                    // Sort by timestamp (newest first, if available)
                    filteredServices.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                    if (this.currentCategory !== 'All') {
                        filteredServices = filteredServices.filter(service => service.category === this.currentCategory);
                    }
                    
                    if (filteredServices.length === 0) {
                        emptyState.classList.remove('hidden');
                    } else {
                        emptyState.classList.add('hidden');
                        filteredServices.forEach(service => {
                            const isOwner = service.ownerId === this.userId;
                            const deleteButton = isOwner 
                                ? `<button onclick="app.deleteService('${service.id}')" class="text-red-500 hover:text-red-700 ml-auto p-1 rounded-full bg-red-100 transition">
                                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" /></svg>
                                   </button>`
                                : '';
                                
                            const card = `
                                <div class="card bg-white p-5 rounded-xl shadow-lg border-t-4 border-fiji-coral flex flex-col">
                                    <div class="flex items-start justify-between">
                                        <div>
                                            <h3 class="text-xl font-bold text-fiji-blue">${service.name}</h3>
                                            <p class="text-sm text-gray-500 mt-1 mb-2">${service.category}</p>
                                        </div>
                                        ${deleteButton}
                                    </div>
                                    <p class="text-gray-700 mb-3">${service.description}</p>
                                    <div class="mt-auto pt-3 border-t border-gray-100 flex items-center justify-between">
                                        <div class="flex items-center text-primary-blue font-medium">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm4 0H9v2h2V9zm3 0h-2v2h2V9z" clip-rule="evenodd" /></svg>
                                            <span>${service.contact}</span>
                                        </div>
                                    </div>
                                </div>
                            `;
                            listContainer.insertAdjacentHTML('beforeend', card);
                        });
                    }
                },
                
                // Form Submission
                submitService: async function(event) {
                    event.preventDefault();
                    
                    if (!this.userId) {
                        this.showAlert("Error", "User is not authenticated. Cannot save service.");
                        return;
                    }

                    const name = document.getElementById('serviceName').value.trim();
                    const category = document.getElementById('category').value;
                    const contact = document.getElementById('contact').value.trim();
                    const description = document.getElementById('description').value.trim();
                    const loader = document.getElementById('modal-loader');
                    
                    loader.classList.remove('hidden');
                    
                    const newService = {
                        name: name,
                        category: category,
                        contact: contact,
                        description: description,
                        ownerId: this.userId, // Store the ID of the user who created it
                        timestamp: serverTimestamp() // Use Firebase server timestamp
                    };
                    
                    try {
                        const publicServicesCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'services');
                        await addDoc(publicServicesCollectionRef, newService);
                        
                        this.showAlert("Success", "Your service has been listed successfully!");
                        document.getElementById('serviceForm').reset();
                        this.closeModal('serviceModal');
                        
                    } catch (e) {
                        console.error("Error adding document: ", e);
                        this.showAlert("Submission Failed", "There was an error saving your service. Please try again.");
                    } finally {
                        loader.classList.add('hidden');
                    }
                },
                
                // Delete Service
                deleteService: async function(serviceId) {
                    // Using custom alert instead of window.confirm
                    this.showAlert("Confirm Delete", "Are you sure you want to delete this service? If so, click OK.");
                    
                    // Since we can't block with a real confirm, we simplify:
                    // If the user clicks OK on the alert, we assume they want to delete.
                    // This is a common simplification in these sandbox environments.
                    
                    const performDelete = async () => {
                        try {
                            const serviceDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'services', serviceId);
                            await deleteDoc(serviceDocRef);
                            this.showAlert("Deleted", "Service removed successfully.");
                        } catch (e) {
                            console.error("Error deleting document: ", e);
                            this.showAlert("Deletion Failed", "Could not delete the service.");
                        }
                    };
                    
                    // We attach the delete logic to the OK button of the custom alert temporarily
                    const okButton = document.querySelector('#customAlert button');
                    okButton.onclick = () => {
                        this.closeModal('customAlert');
                        performDelete();
                        // Reset the OK button action to the default close function
                        okButton.onclick = () => app.closeModal('customAlert');
                    };
                }
            };

            // Start the application initialization
            window.app.initializeAuth();
        }
    </script>
</body>
</html>

